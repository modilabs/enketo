<!DOCTYPE HTML>
<html lang="en">
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<title>Source - src/js/__test.js</title>
	<meta name="generator" content="JsDoc Toolkit" />

	<link media="all" rel="stylesheet" href="../../css/common.css" type="text/css" />
	<link media="all" rel="stylesheet" href="../../css/bootstrap.min.css" type="text/css" />
	<link media="all" rel="stylesheet" href="../../css/prettify.css" type="text/css" />
	<link media="print" rel="stylesheet" href="../../css/print.css" type="text/css" />
	<style type="text/css">
		.icon-jsdoc {
			background: url("../../img/classicons.png") no-repeat;
		}
	</style>
	<script type="text/javascript" src="http://code.jquery.com/jquery-1.7.2.min.js"></script>
	<script src="../../js/prettify.js" type="text/javascript"></script>
	<script src="../../js/bootstrap.min.js" type="text/javascript"></script>
</head>
<body><div class="container-fluid">
<!-- ============================== header ================================= -->
	<!-- begin static/header.html -->
	<header class="header navbar navbar-fixed-top">
		<div class="navbar-inner">
			<div class="container-fluid">
				<a class="brand" href="#"><strong>JsDoc</strong> Reference</a>
				<ul id="class-file-selector" class="nav">
					<li><a href="../../index.html">Class Index</a></li>
					<li><a href="../../files.html">File Index</a></li>
				</ul>
			</div>
		</div>
	</header>
	<!-- end static/header.html -->

<!-- ============================== classes index ============================ -->
	<div class="row-fluid">
		<div id="index" class="span3">
			<!-- begin publish.classesIndex -->
			<div class="well" id="class-list">
	<ul class="nav nav-list">
		<li class="nav-header">Classes</li>
		
			<li><a href="../../symbols/Cache.html"><span class="indent" style="padding-left:0px;"><i class="icon-jsdoc icon-jsdoc-class"></i><span class="jsdoc-class-index">Cache</span></span></a></li>
		
			<li><a href="../../symbols/Connection.html"><span class="indent" style="padding-left:0px;"><i class="icon-jsdoc icon-jsdoc-class"></i><span class="jsdoc-class-index">Connection</span></span></a></li>
		
			<li><a href="../../symbols/Date.html"><span class="indent" style="padding-left:0px;"><i class="icon-jsdoc icon-jsdoc-namespace"></i><span class="jsdoc-class-index">Date</span></span></a></li>
		
			<li><a href="../../symbols/Form.html"><span class="indent" style="padding-left:0px;"><i class="icon-jsdoc icon-jsdoc-class"></i><span class="jsdoc-class-index">Form</span></span></a></li>
		
			<li><a href="../../symbols/Form-DataXML.html"><span class="indent" style="padding-left:0px;"><i class="icon-jsdoc icon-jsdoc-class"></i><span class="jsdoc-class-index">DataXML</span></span> <span class="pull-right label label-jsdoc label-jsdoc-inner">Inner</span> </a></li>
		
			<li><a href="../../symbols/Form-DataXML-Nodeset.html"><span class="indent" style="padding-left:0px;"><i class="icon-jsdoc icon-jsdoc-class"></i><span class="jsdoc-class-index">Nodeset</span></span> <span class="pull-right label label-jsdoc label-jsdoc-inner">Inner</span> </a></li>
		
			<li><a href="../../symbols/Form-FormHTML.html"><span class="indent" style="padding-left:0px;"><i class="icon-jsdoc icon-jsdoc-class"></i><span class="jsdoc-class-index">FormHTML</span></span> <span class="pull-right label label-jsdoc label-jsdoc-inner">Inner</span> </a></li>
		
			<li><a href="../../symbols/FormHTML%23Branch.html"><span class="indent" style="padding-left:0px;"><i class="icon-jsdoc icon-jsdoc-class"></i><span class="jsdoc-class-index">Branch</span></span></a></li>
		
			<li><a href="../../symbols/GUI.html"><span class="indent" style="padding-left:0px;"><i class="icon-jsdoc icon-jsdoc-class"></i><span class="jsdoc-class-index">GUI</span></span></a></li>
		
			<li><a href="../../symbols/Print.html"><span class="indent" style="padding-left:0px;"><i class="icon-jsdoc icon-jsdoc-class"></i><span class="jsdoc-class-index">Print</span></span></a></li>
		
			<li><a href="../../symbols/Settings.html"><span class="indent" style="padding-left:0px;"><i class="icon-jsdoc icon-jsdoc-class"></i><span class="jsdoc-class-index">Settings</span></span></a></li>
		
			<li><a href="../../symbols/State.html"><span class="indent" style="padding-left:0px;"><i class="icon-jsdoc icon-jsdoc-class"></i><span class="jsdoc-class-index">State</span></span></a></li>
		
			<li><a href="../../symbols/StorageLocal.html"><span class="indent" style="padding-left:0px;"><i class="icon-jsdoc icon-jsdoc-class"></i><span class="jsdoc-class-index">StorageLocal</span></span></a></li>
		
			<li><a href="../../symbols/String.html"><span class="indent" style="padding-left:0px;"><i class="icon-jsdoc icon-jsdoc-namespace"></i><span class="jsdoc-class-index">String</span></span></a></li>
		
			<li><a href="../../symbols/_global_.html"><span class="indent" style="padding-left:0px;"><i class="icon-jsdoc icon-jsdoc-namespace"></i><span class="jsdoc-class-index">_global_</span></span></a></li>
		
	</ul>
</div>

			<!-- end publish.classesIndex -->
		</div>

		<div id="content" class="span9">
<!-- ============================== source code ============================ -->

			<pre id="source-code" class="prettyprint linenums">/**
 * @preserve Copyright 2012 Martijn van de Rijdt
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/*jslint browser:true, devel:true, jquery:true, smarttabs:true*//*global GUI, gui, Form, Connection, Modernizr, getGetVariable, vkbeautify*/
var form, source, url, $tabs, $upload, _error, state, connection,
	error_msg = 'There were errors. Please see the "report" tab for details.',
	templateShow = false,
	store = {},
	settings = {};

$(document).ready(function(){
	"use strict";
	connection = new Connection();
	state = new State();
	state.init();
	

	$('[title]').tooltip();

	_error = console.error;
	console.error = function(){
		addJsError(arguments[0]);
		gui.showFeedback(error_msg);
		return _error.apply(console, arguments);
	};

	if (!state.source){
		$('#html5-form-source').hide();
		$('li a[href="#html5-form-source"]').parent('li').remove();
	}

	$('li a[href="#upload"]').tab('show');

	gui.setup();

	$('#upload-form [name="xml_file"]').change(function(){
		$('#upload-form').submit();
		resetForm();
	});

	$('#upload-form').submit(function(){
		var formId = $(this).find('[name="form_id"]').val(),
			serverURL = $(this).find('[name="server_url"]').val(),
			error = function(jqXHR, status, errorThrown){
				if (status !== 'validationerror'){
					gui.showFeedback('Sorry, an error occured while communicating with the Enketo server. ('+errorThrown+')');
				}
				else {
					gui.alert(errorThrown);
					resetForm();
				}
			},
			complete = function(jqXHR, textStatus){
				$('#upload-form progress').hide();
			};

		$('#upload-form progress').show();

		if ( formId || $(this).find('[name="xml_file"]').val()){
			connection.getFormHTML($(this), {
				success: function(resp, textStatus, jqXHR){
					state.server = (serverURL) ? serverURL : null;
					state.id = (formId) ? formId : null;
					state.setUrl();
					processForm($(resp));
				},
				error: error,
				complete: complete
			});
		}
		else{
			connection.getFormlist(serverURL, {
				success: function(resp, textStatus, jqXHR){
					$('#upload .hurry').hide();
					state.server = serverURL;
					state.id = null;
					state.setUrl();
					processFormlist(resp);
				},
				error: error,
				complete: complete
			});
		}
		return false;
	});

	$('#upload-form #input-switcher a')
		.click(function(e){
			e.preventDefault();
			$('#upload-form label').hide().find('input[name="'+$(this).attr('id')+'"]').parents('label').show();
			$(this).siblings().removeClass('active');
			$(this).addClass('active');
		});

	$('#data-template-show input').change(function(){
		templateShow = ($(this).is(':checked')) ? true : false;
		updateData();
	});

	$(document).on('click', '#form-list a', function(event){
		var id = /** @type {string} */ $(this).attr('id');
		event.preventDefault();
		//console.debug('form clicked');
		//$('#upload-form input[name="xml_url"]').val($(this).attr('href'));
		$('#upload-form input[name="form_id"]').val(id);
		$('#upload-form').submit();
	});

	$('#html5-form-source form').submit(function(){
		var cls, $form = $(this);
		var html = '&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;meta charset="utf-8" /&gt;&lt;title&gt;&lt;/title&gt;&lt;/head&gt;&lt;body&gt;'+
			$form.find('textarea[name="content"]').val()+'&lt;/body&gt;&lt;/html&gt;';
		
		$('#html5validationmessages div').html('&lt;form style="text-align:center;"&gt;&lt;progress&gt;&lt;/progress&gt;&lt;/form&gt;');
		
		connection.validateHTML(html, {
			success: function(response){
				//strip &lt;script&gt; elements
				var $response = $('&lt;div&gt;&lt;/div&gt;');
				$response.append(response.replace(/&lt;script[A-z =".]*&gt;&lt;\/script&gt;/gi, ''));
				$response.find('ol:not(.source) li&gt;*:first-child').each(function(){
					cls = /**@type {string} */$(this).parent('li').attr('class');
					$(this).addClass(cls);
				});
				parseMsgList ($response.find('p.success, ol:not(.source) li&gt;*:first-child'), $('#html5validationmessages div'));
				//correction as Web Service does not accept 'level: 'error' parameter:
				$('#html5validationmessages div li.info').hide();
			},
			error: function(){
				$('#html5validationmessages div').empty().append('&lt;ol&gt;&lt;li class="info"&gt;'+
					'&lt;span class="ui-icon ui-icon-info"&gt;&lt;/span&gt;This validation is currently not functional&lt;/li&gt;&lt;/ol&gt;');
			}
		});
		return false;
	});
	
	$('#upload-form #input-switcher a#server_url').click();

	$('#launch form').submit(function(){
		var serverURL = $(this).find('[name="server_url"]').val(),
			formId = $(this).find('[name="form_id"]').val();

		gui.alert('&lt;form style="text-align:center;&gt;&lt;progress&gt;&lt;/progress&gt;&lt;/form&gt;', 'Requesting url...', 'normal');

		connection.getSurveyURL(serverURL, formId, {
			error: function(response){
				gui.alert('Ouch, an error occurred during the request. Please try again.');
			},
			success: function(response){
				//{success: true, url: .......}
				//{success: false, reason: 'existing', url: ....}
				//{success: false, reason: 'empty'} empty form fields sent in POST
				//{success: false, reason: 'database'} error inserting record into database
				//{succces: false, reason: ''} unknown, could be invalid url(s)
				console.log('form submission complete');
				if (response.success){
					gui.alert('Form was succesfully launched at this address: '+
						'&lt;a class="launch-link" href="'+response.url+'"&gt;'+response.url+'&lt;/a&gt;', 'Launched!', 'success');
				}
				else{
					switch(response.reason){
						case 'existing':
							gui.alert('This survey was launched before at this address: '+
								'&lt;a class="launch-link" href="'+response.url+'"&gt;'+response.url+'&lt;/a&gt;', 'Launched!', 'success');
							break;
						case 'empty':
							gui.alert('Server url and/or form id submitted to the server found to be empty.', 'Failed');
							break;
						case 'database':
							gui.alert('Problem occurred trying to add survey details to Enketo database to launch.', 'Failed');
							break;
						default:
							gui.alert('Unknown error', 'Failed');
					}
				}
			}
		});
		return false;
	});

	if (state.server){
		$('#upload-form input[name="server_url"]').val(state.server);
			$('#upload-form input[name="form_id"]').val(state.id);
		$('#upload-form').submit();
	}
});

/**
 * State class maintains 'fake' state using url GET variables
 *
 * @constructor
 */
function State(){
	
}

State.prototype.init = function (){
	var first = true,
		serverGetVar = decodeURIComponent(decodeURI(getGetVariable('server')));

	this.server = ( serverGetVar &amp;&amp; connection.isValidURL(serverGetVar) ) ? serverGetVar : null;
	this.id = getGetVariable('id') || null; //CHECK THIS FOR 'VALIDITY'
	this.source = getGetVariable('source') || false;
	this.debug = getGetVariable('debug') || false;

	state.setUrl();

	$(window).on('popstate', function(){

		if (!first){
			window.location = location.href;
		}
		first = false;
	});
	// really not elegant....
	setTimeout(function(){first=false;}, 5000);
};

State.prototype.setUrl = function(){
	var stateProps = {server: this.server, id: this.id, source: this.source, debug: this.debug},
		urlAppend = '',
		url = 'test';
	urlAppend = (this.server !== null &amp;&amp; connection.isValidURL(this.server)) ? urlAppend+'server='+encodeURIComponent(this.server) : urlAppend;
	urlAppend = (this.id !== null) ? urlAppend+'&amp;id='+encodeURIComponent(this.id) : urlAppend;
	urlAppend = (this.source == 'true' || this.source === true ) ? urlAppend+'&amp;source='+encodeURIComponent(this.source) : urlAppend;
	urlAppend = (this.debug == 'true' || this.debug === true ) ? urlAppend+'&amp;debug='+encodeURIComponent(this.debug) : urlAppend;
	urlAppend = (urlAppend.substring(0,1) == '&amp;') ? urlAppend.substring(1) : urlAppend;
	url = (urlAppend.length &gt; 0) ? url+'?'+urlAppend : url;
	if (location.href !== location.protocol+'//'+location.hostname+'/'+url ){
		console.debug('pushing history state ');
		console.debug(location.href);
		console.debug(location.hostname+'/'+url);
		console.debug(stateProps);
		history.pushState( stateProps, 'Enketo Launch', url);
	}
};

State.prototype.setIdFromUrl = function(url){
	var id;
	if (!connection.isValidURL(url)){
		this.id = null;
	}
	id = url.match(/formhub\.org\/[A-z\_0-9\-]*\/forms\/([A-z\_0-9\-]*)\/form\.xml/i);
	if (!id){
		id = url.match(/formXml\?formId=([A-z\_0-9\-]*)/i);
	}
	return (id) ? this.id = id[1] : console.error('could not extract id from url: '+url);
};

State.prototype.reset = function(){
	console.debug('resetting state');
	this.server = null;
	this.id = null;
	this.setUrl();
};

GUI.prototype.setCustomEventHandlers = function(){
	
	$(document).on('click', 'button#validate-form:not(.disabled)', function(){
		//$('form.jr').trigger('beforesave');
		if (typeof form !== 'undefined'){
			form.validateForm();
		}
	});

	$(document).on('click', 'button#launch-form:not(.disabled)', function(){
		var dataUrl, errorMsg;
		if (!state.server){
			errorMsg = 'Requires a server url and ';
		}
		if (!state.id){
			errorMsg = (errorMsg) ? errorMsg : 'Requires ';
			errorMsg += 'a form to be selected first.';
		}
		dataUrl = $('#launch [name="data_url"]').val();
		if (dataUrl.length &gt; 0 &amp;&amp; !connection.isValidURL(dataUrl)){
			errorMsg = (errorMsg) ? errorMsg+'&lt;br/&gt;' : '';
			errorMsg += 'The publication link is not a valid url';
		}
		if (errorMsg &amp;&amp; errorMsg.length &gt; 0){
			$('#launch p.alert.alert-error').html(errorMsg).show();
		}
		else{
			$('#launch [name="server_url"]').val(state.server);
			$('#launch [name="form_id"]').val(state.id);
			$('#launch p.alert.alert-error').empty().hide();
			$('#launch form').submit();
		}
	});

	$('#launch a.advanced').click(function(event){
		event.preventDefault();
		if ($(this).hasClass('active')){
			$(this).text('show advanced options').removeClass('active').siblings('fieldset.advanced').hide();
		}
		else{
			$(this).text('hide advanced options').addClass('active').siblings('fieldset.advanced').show();
		}
	});

};

function resetForm(){
	"use strict";
	//$content.hide();
	//$upload.show();
	state.reset();
	//$('#upload-form')[0].reset();
	$('#upload-form input[type="hidden"]').val('');
	$('#form-list ul').empty().hide();
	$('#upload-form progress').hide();
	$('#input-switcher, #upload .hurry').show().find('a#server_url').click();
	$('#form-languages').remove();
	//gui.updateStatus.edit(false);
	$('#survey-form form, #xsltmessages div, #html5validationmessages div, #jrvalidationmessages div, #xmlerrors div, #xslerrors div, #html5-form-source textarea, #data textarea').empty();
	form = null;
	$('#validate-form').addClass('disabled');
	$('.nav li a[href="#upload"]').tab('show');
	//$tabs.hide();
}

function processForm($response){
	var formStr = new XMLSerializer().serializeToString($response.find('form')[0]);
	//data as string
	var jrDataStr = new XMLSerializer().serializeToString($response.find('instance')[0]);
	//extract messages
	var $xsltMsg = $response.find('xsltmessages message');
	//var $html5Msg = $response.find('html5validatormessages message');
	var $jrMsg = $response.find('jrvalidationmessages message');
	var $xmlMsg = $response.find('xmlerrors message');
	var $xslMsg = $response.find('xslformerrors message, xsldataerrors message');

	$('#upload-form progress').hide();
	
	if(formStr.length &gt; 0){
		$('#html5-form-source textarea').empty().text(vkbeautify.xml(formStr));
		$('#html5-form-source form').submit();
		
		//important to use append with string and not $object for some reason =&gt; JQuery bug?
		$('#survey-form form').replaceWith(formStr);
		
		form = new Form('form.jr:eq(0)', jrDataStr);
		form.init();
			
		$('.nav a[href="#survey-form"]').tab('show');
		
		//set event handlers for changes in form input fields
		$(document).on('change dataupdate', 'form.jr', updateData);

		//enable buttons
		$('#validate-form').removeClass('disabled');
	}
	else {
		$('#survey-form div').empty();
		$('.nav li a[href="#report"]').tab('show');
	}
	
	if (form &amp;&amp; form.getDataStr().length &gt; 0){
		updateData();
	}
	else{
		$('#data div').text('An error occurred whilst trying to extract the data.');
	}
	
	if (form &amp;&amp; form.getDataStr().length &gt; 0 &amp;&amp; $xsltMsg.length === 0){
		$xsltMsg = $('&lt;message class="success"&gt;Nothing reported back. A good sign if there are no other errors!&lt;/message&gt;');
	}
	parseMsgList ($xsltMsg, $('#xsltmessages div'));

	if ($jrMsg.length === 0){
		$jrMsg = $('&lt;message class="info"&gt;Something went wrong&lt;/message&gt;');
	}
	parseMsgList ($jrMsg, $('#jrvalidationmessages div'));
	
	if ($xmlMsg.length === 0){
		$xmlMsg = $('&lt;message class="success"&gt;Valid XML document!&lt;/message&gt;');
	}
	parseMsgList ($xmlMsg, $('#xmlerrors div'));
	
	if ($xslMsg.length &gt; 0){
		$xslMsg.each(function(){
			console.error('XSLT stylesheet error: '+$(this).text());
		});
	}
	
	if (form &amp;&amp; form.getDataStr().length &gt; 0 &amp;&amp; $('#report .level-2, #report .level-3').length &gt; 0){
		gui.showFeedback(error_msg);
	}
}

//duplicate of parseFormList() in __formlist.js (TODO: reorganize)
function processFormlist(list)
{
	"use strict";
	var i, listHTML='';
	if(list){
		for (i in list){
			listHTML += '&lt;li&gt;&lt;a class="btn btn-block btn-info" id="'+i+'" title="'+list[i].title+'" '+
				'href="'+list[i].url+'" data-server="'+list[i].server+'" &gt;'+list[i].name+'&lt;/a&gt;&lt;/li&gt;';
		}
	}
	else{
		listHTML = '&lt;p class="alert alert-error"&gt;Error occurred during creation of form list&lt;/p&gt;';
		resetForm();
	}
	$('#form-list').removeClass('empty').find('ul').empty().append(listHTML);
	$('#upload-form progress').hide();
	$('#form-list').show();
}

function updateData(){
	"use strict";
	if (form){
		var dataStr = form.getDataStr(templateShow);
		//console.log('updating data tab');// with string: '+dataStr);
		$('#data textarea').empty().text(vkbeautify.xml(dataStr));
	}
	else {
		//console.log('nothing to do, there is no form');
	}
}

function parseMsgList(msgObj, targetEl){
	"use strict";
	var messageList = $('&lt;ul&gt;&lt;/ul&gt;');
	msgObj.each(function(){
		var level = '', liStr, cls, icon = '', message = $(this).text(),
			classes = {'0':'info', 'info warning':'warning', '1':'warning', '2':'error', '3':'error'};
		level = $(this).attr('level') ? $(this).attr('level') : $(this).attr('class');
		cls = (classes[level]) ? "text-"+classes[level] : "muted";
		liStr = '&lt;li class="'+cls+'"&gt;'+message+'&lt;/li&gt;';
				
		//avoid duplicate messages
		if (messageList.find('li').filter(function(){return $(this).text() == message;}).length === 0) {
			messageList.append(liStr);
		}
	});
	targetEl.empty().append(messageList);
}

function addJsError(message){
	"use strict";
	if ($('#jserrors div ul').length !== 1){
		$('#jserrors div').append('&lt;ul&gt;&lt;/ul&gt;');
	}
	$('#jserrors div ul').append('&lt;li class="text-error"&gt;'+message+'&lt;/li&gt;');
}</pre>
		</div>
	</div>

<!-- ============================== footer ================================= -->
	<footer class="footer">
		
		<p>Documentation generated by <a href="http://code.google.com/p/jsdoc-toolkit/" target="_blankt">JsDoc Toolkit</a> 2.4.0 on Fri Dec 07 2012 17:49:17 GMT-0700 (MST)</p>
	</footer>
</div>
<script type="text/javascript">
	prettyPrint();
	var i = 1;
	$('#source-code li').each(function() {
		$(this).attr({ id: 'line' + (i++) });
	});
</script>
</body>
</html>
