/*
 Copyright 2012 Martijn van de Rijdt

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
*/
var gui,DEFAULT_SETTINGS={};$(document).ready(function(){gui=new GUI;gui.init();"undefined"==typeof console&&(console={log:function(){}});"undefined"==typeof window.console.debug&&(console.debug=console.log);"true"!==getGetVariable("debug")&&(window.console.log=function(){},window.console.debug=function(){})});function GUI(){}
GUI.prototype.init=function(){this.nav.setup();this.pages().init();this.setEventHandlers();"function"===typeof this.setCustomEventHandlers&&this.setCustomEventHandlers();$(".dialog [title]").tooltip();Modernizr.borderradius&&(Modernizr.boxshadow&&Modernizr.csstransitions&&Modernizr.opacity)&&$(document).trigger("browsersupport","fancy-visuals");$("footer").detach().appendTo("#container");this.display()};GUI.prototype.setup=function(){$(window).trigger("resize");$(".ui-corner-all").removeClass("ui-corner-all")};
GUI.prototype.setEventHandlers=function(){var a=this;$("#feedback-bar-close").button({icons:{primary:"ui-icon-closethick"},text:!1}).click(function(b){b.preventDefault();a.hideFeedback()});$("#page-close").button({icons:{primary:"ui-icon-closethick"},text:!1}).click(function(b){b.preventDefault();a.pages().close()});$("#feedback-bar-close, #page-close").removeClass().addClass("custom-button ui-widget-header ui-corner-all");$(document).on("click",'a[href^="#"]:not([href="#"]):not(nav ul li a)',function(a){var c=
$(this).attr("href");console.log("captured click to nav page, href="+c);"#"!==c&&(a.preventDefault(),$('nav li a[href="'+c+'"]').click())});$('nav ul li a[href^="#"]').click(function(b){b.preventDefault();b=$(this).attr("href").substr(1);a.pages().open(b);$(this).closest("li").addClass("nav-state-active")});$(window).on("onlinestatuschange",function(b,c){a.updateStatus.connection(c)});$(document).on("edit","form.jr",function(b,c){a.updateStatus.edit(c)});$(document).on("browsersupport",function(b,
c){a.updateStatus.support(c)});$("#page, #feedback-bar").on("change",function(){a.display()});$("header #status-connection").click(function(b){a.showFeedback($(this).attr("title"));b.stopPropagation()});$(window).resize(function(){$("#container").css("top",$("header").outerHeight());$("body:not(.no-scroll) #container").height($(window).height()-$("header").outerHeight()-$("#form-controls.bottom").outerHeight());if(0<$("nav").length){var a=$("nav").offset().left,c=$("#logo").offset().left+$("#logo").outerWidth();
a<c?$("#logo").css("visibility","hidden"):$("#logo").css("visibility","visible")}})};GUI.prototype.nav={setup:function(){$("article.page").each(function(){var a,b="",c;c=$(this).attr("id");a=$(this).attr("data-display")?$(this).attr("data-display"):c;b=$(this).attr("data-title")?$(this).attr("data-title"):c;c=$(this).attr("data-ext-link")?$(this).attr("data-ext-link"):"#"+c;$('<li class="ui-corner-tl ui-corner-tr"><a href="'+c+'" title="'+b+'" >'+a+"</a></li>").appendTo($("nav ul"))})},reset:function(){$("nav ul li").removeClass("nav-state-active")}};
GUI.prototype.pages=function(){this.init=function(){this.$pages=$("<pages></pages>");$("article.page").detach().appendTo(this.$pages)};this.get=function(a){var b=this.$pages.find('article[id="'+a+'"]');return b=0<b.length?b:$('article[id="'+a+'"]')};this.isShowing=function(a){return 0<$("#page article.page"+("undefined"!==typeof a?'[id="'+a+'"]':"")).length};this.open=function(a){var b;if(!this.isShowing(a)){b=this.get(a);if(1!==b.length)return console.error("page not found");this.isShowing()&&this.close();
$("#page-content").prepend(b.show()).trigger("change");$("#overlay").show();setTimeout(function(){b.find(".scroll-list").addScrollBar();$("#overlay, header").bind("click.pageEvents",function(){$("#page-close").trigger("click")})},50);$(window).bind("resize.pageEvents",function(){$("#page").trigger("change")})}};this.close=function(){var a;a=$("#page .page").detach();this.$pages.append(a);$("#page").trigger("change");this.nav.reset();$("#overlay").hide();$("#overlay, header").unbind(".pageEvents");
$(window).unbind(".pageEvents")};return this};GUI.prototype.showFeedback=function(a,b){var c,b=b?1E3*b:1E4;$("#feedback-bar p").eq(1).remove();$("#feedback-bar p").html()!==a&&(c=$("<p></p>"),c.text(a),$("#feedback-bar").prepend(c));$("#feedback-bar").trigger("change");setTimeout(function(){typeof c!=="undefined"&&c.remove();$("#feedback-bar").trigger("change")},b)};GUI.prototype.hideFeedback=function(){$("#feedback-bar p").remove();$("#feedback-bar").trigger("change")};
GUI.prototype.alert=function(a,b,c){var d=$("#dialog-alert"),b=b||"Alert",c=c||"ui-icon-alert";d.find("p .ui-icon:eq(0)").removeClass().addClass("ui-icon "+c);c=function(){d.dialog("destroy");d.find("#dialog-alert-msg").text("")};d.find("#dialog-alert-msg").html(a).capitalizeStart();d.dialog({title:b,modal:!0,resizable:!1,closeOnEscape:!0,buttons:{Ok:c},beforeClose:c,width:500})};
GUI.prototype.confirm=function(a,b){var c,d,f,g,e;"string"===typeof a?c=a:"string"===typeof a.msg&&(c=a.msg);c="undefined"!==typeof c?c:"Please confirm action";d="undefined"!==typeof a.heading?a.heading:"Are you sure?";g="undefined"!==typeof a.dialog?a.dialog:"confirm";b="undefined"!==typeof b?b:{};b.posButton=b.posButton||"Confirm";b.negButton=b.negButton||"Cancel";b.posAction=b.posAction||function(){return false};b.negAction=b.negAction||function(){return false};b.beforeAction=b.beforeAction||function(){};
f=function(){e.dialog("destroy");e.find(".dialog-msg, .dialog-error").text("");console.debug("dialog destroyed")};e=$("#dialog-"+g);e.find(".dialog-msg").html(c).capitalizeStart();e.dialog({open:b.beforeAction,title:d,resizable:!1,modal:!0,closeOnEscape:!0,buttons:[{text:b.posButton,click:function(){b.posAction.call();e.find(".dialog-error").text().length===0&&f.call()}},{text:b.negButton,click:function(){b.negAction.call();f.call()}}],width:500,beforeClose:f})};
GUI.prototype.updateStatus={connection:function(a){console.log("updating online status in menu bar to:");console.log(a);!0===a?($("header #status-connection").removeClass().addClass("ui-icon ui-icon-signal-diag").attr("title","It appears there is currently an Internet connection available."),$(".drawer #status").removeClass("offline waiting").text("")):!1===a?($("header #status-connection").removeClass().addClass("ui-icon ui-icon-cancel").attr("title","It appears there is currently no Internet connection"),
$(".drawer #status").removeClass("waiting").addClass("offline").text("Offline. ")):$(".drawer #status").removeClass("offline").addClass("waiting").text("Waiting. ")},edit:function(a){a?$("header #status-editing").removeClass().addClass("ui-icon ui-icon-pencil").attr("title","Form is being edited."):$("header #status-editing").removeClass().attr("title","")},support:function(a){var b=gui.pages().get("settings");0<b.length&&(console.debug("updating browser support for "+a),b.find("#settings-browserSupport-"+
a+" span.ui-icon").addClass("ui-icon-check"))},offlineLaunch:function(a){$(".drawer #status-offline-launch").text(a?"Offline Launch: Yes":"Offline Launch: No")}};
GUI.prototype.display=function(){var a,b;b=$("header");var c=$("#feedback-bar"),d=$("#page");0<c.find("p").length?(a=b.outerHeight(),b=this.pages().isShowing()?b.outerHeight()+c.outerHeight():b.outerHeight()+c.outerHeight()-d.outerHeight()):(a=b.outerHeight()-c.outerHeight(),b=this.pages().isShowing()?b.outerHeight():b.outerHeight()-d.outerHeight());c.css("top",a);d.css("top",b)};
GUI.prototype.setSettings=function(a){var b,c=this;console.log("gui updateSettings() started");$.each(a,function(a,f){b=f?c.pages().get("settings").find('input[name="'+a+'"][value="'+f+'"]'):c.pages().get("settings").find('input[name="'+a+'"]');0<b.length&&b.attr("checked",f?!0:!1).trigger("change")})};function getGetVariable(a){for(var b=window.location.search.substring(1).split("&"),c=0;c<b.length;c++){var d=b[c].split("=");if(d[0]==a)return encodeURI(d[1])}return!1}
String.prototype.pad=function(a){for(var b=this;b.length<a;)b="0"+b;return b};
(function(a){a.fn.equalWidth=function(){var b=0;return this.each(function(){a(this).width()>b&&(b=a(this).width())}).each(function(){a(this).width(b)})};a.fn.reverse=[].reverse;a.fn.alphanumeric=function(b){b=a.extend({ichars:"!@#$%^&*()+=[]\\';,/{}|\":<>?~`.- ",nchars:"",allow:""},b);return this.each(function(){b.nocaps&&(b.nchars+="ABCDEFGHIJKLMNOPQRSTUVWXYZ");b.allcaps&&(b.nchars+="abcdefghijklmnopqrstuvwxyz");for(var c=b.allow.split(""),d=0;d<c.length;d++)-1!=b.ichars.indexOf(c[d])&&(c[d]="\\"+
c[d]);b.allow=c.join("|");var f=b.ichars+b.nchars,f=f.replace(RegExp(b.allow,"gi"),"");a(this).keypress(function(a){var b;b=a.charCode?String.fromCharCode(a.charCode):String.fromCharCode(a.which);f.indexOf(b)!=-1&&a.preventDefault();a.ctrlKey&&b=="v"&&a.preventDefault()});a(this).bind("contextmenu",function(){return false})})};a.fn.numeric=function(b){var c="abcdefghijklmnopqrstuvwxyz",c=c+c.toUpperCase(),b=a.extend({nchars:c},b);return this.each(function(){a(this).alphanumeric(b)})};a.fn.alpha=function(b){b=
a.extend({nchars:"1234567890"},b);return this.each(function(){a(this).alphanumeric(b)})};a.fn.capitalizeStart=function(a){a||(a=1);var c=this.contents().filter(function(){return 3==this.nodeType}).first(),d=c.text(),a=d.split(" ",a).join(" ");c.length&&(c[0].nodeValue=d.slice(a.length),c.before('<span class="capitalize">'+a+"</span>"))};a.fn.addScrollBar=function(){return this.each(function(){var b=a(this),c=a(this).find("ol");b.css("overflow","hidden");var d=c.height()-b.height();if(0<d){var f=d/
c.height(),f=Math.round((1-f)*b.height()),f=f-f%2;a("#records .column.middle").html('<div id="slider-wrap" class="ui-corner-all"><div id="slider-vertical"></div></div>');a("#slider-wrap").height(b.outerHeight());a("#slider-vertical").slider({orientation:"vertical",range:"max",min:0,max:100,value:100,slide:function(a,b){c.css({top:-((100-b.value)*d/100)})}});a("#slider-wrap").css("margin-top",a("#records-saved h3").outerHeight(!0));a(".ui-slider-handle").css({height:f,"margin-bottom":-0.5*f});b=a("#slider-vertical").height();
f=b-f;b=0.5*(b-f);a(".ui-slider").css({height:f,"margin-top":b});a(".ui-slider-range").css({top:-b});a("#slider-wrap").click(function(){a("#slider-vertical").slider("value",0);c.css({top:-d})})}})}})(jQuery);/*
 Copyright 2012 Martijn van de Rijdt

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
*/
function StorageLocal(){function a(a){var c;for(c=0;c<b.length;c++)if(a===b[c])return!0;return!1}var b="__settings null __history Firebug undefined __bookmark __counter".split(" "),c=window.localStorage;this.isSupported=function(){try{return"localStorage"in window&&null!==window.localStorage}catch(a){return!1}};this.getForbiddenKeys=function(){return b};this.setRecord=function(b,f,g,e,i){console.debug("setRecord received record with final: "+f.ready);if(!b||1>b.length)return console.error("no key provided for record"),
"require";b=b.trim();i="string"===typeof i?i.trim():null;e="undefined"!==typeof e&&!0===e?!0:!1;if("string"===typeof f.data&&a(b))return"forbidden";var h;if(h="string"===typeof f.data)if(h=i!==b)h=c.getItem(b)?!0:!1,h=h&&!0!==e;if(h)return"existing";try{return"string"===typeof f.data&&(f.lastSaved=(new Date).getTime(),c.setItem("__counter",JSON.stringify({counter:this.getCounterValue()}))),c.setItem(b,JSON.stringify(f)),console.debug("saved: "+b+", old key was: "+i),null!==i&&(""!==i&&i!==b)&&g&&
(console.log("going to remove old record with key:"+i),this.removeRecord(i)),"success"}catch(s){return console.log("error in store.setRecord:"+s.message),"error"}};this.getRecord=function(a){var b;try{return b=JSON.parse(c.getItem(a))}catch(g){return console.error("error with loading data from store: "+g.message),null}};this.removeRecord=function(a){try{return c.removeItem(a),!0}catch(b){return console.log("error with removing data from store: "+b.message),!1}};this.getFormList=function(){var a,b,
c=[],e=this.getSurveyRecords(!1);for(a=0;a<e.length;a++)b=e[a],c.push({key:b.key,ready:b.ready,lastSaved:b.lastSaved});console.debug("formList returning "+c.length+" items");c.sort(function(a,h){return h.lastSaved-a.lastSaved});return c};this.getSurveyRecords=function(b,f){var g,e,i=[],h={},b=b||!1,f=f||null;for(g=0;g<c.length;g++)if(e=c.key(g),h=this.getRecord(e),!a(e))try{h.key=e,console.debug("this record is surveyData: "+h.key),console.debug("excludename: "+f),console.debug("record.ready: "+h.ready+
" type:"+typeof h.ready),e!==f&&(!b||"true"===h.ready||!0===h.ready)&&i.push(h)}catch(s){console.log("record found that was probably not in the correct JSON format (e.g. Firebug settings or corrupt record) (error: "+s.message+"), record was ignored")}return i};this.getSurveyDataArr=function(a,b){var c,e,i=[];e=this.getSurveyRecords(a||!0,b);for(c=0;c<e.length;c++)i.push({name:e[c].key,data:e[c].data});return i};this.getSurveyDataOnlyArr=function(a){for(var b=this.getSurveyDataArr(a),c=[],a=0;a<b.length;a++)c.push(b[a].data);
return 0<c.length?c:null};this.getCounterValue=function(){var a=this.getRecord("__counter");return((a&&"undefined"!==typeof a.counter&&isNumber(a.counter)?Number(a.counter):0)+1).toString().pad(4)}}function isNumber(a){return!isNaN(parseFloat(a))&&isFinite(a)}function Settings(){}Settings.prototype.init=function(){var a=this.get();$(document).trigger("setsettings",a)};Settings.prototype.get=function(){return DEFAULT_SETTINGS};
Settings.prototype.getOne=function(a){var b=this.get();return"undefined"!==typeof a&&"undefined"!==typeof b[a]?b[a]:null};Settings.prototype.set=function(a,b){var c;c=this.get();console.debug("going to store setting: "+a+" with value:"+b);c[a]=b;c=store.setRecord("__settings",c);if("undefined"!==typeof this[a])this[a](b);return"success"===c?!0:console.error("error storing settings")};/*
 Copyright 2012 Martijn van de Rijdt

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
*/
function Form(a,b){function c(a){function b(a,h,c){this.selector="undefined"!==typeof a&&a?a:"*";this.filter=c="undefined"!==typeof c&&null!==c?c:{};this.filter.noTemplate="undefined"!==typeof c.noTemplate?c.noTemplate:!0;this.filter.onlyLeaf="undefined"!==typeof c.onlyLeaf?c.onlyLeaf:!1;this.filter.onlyTemplate="undefined"!==typeof c.onlyTemplate?c.onlyTemplate:!1;this.filter.noEmpty="undefined"!==typeof c.noEmpty?c.noEmpty:!1;this.index=h}var c,d=this,a=a.replace(/<[\/]?instance(>|\s+[^>]*>)/gi,
"");this.xml=$.parseXML(a);this.$=c=$(this.xml);XPathJS.bindDomLevel3XPath();this.node=function(a,h,c){return new b(a,h,c)};b.prototype.get=function(){var a,h;a=!0===this.filter.onlyTemplate?c.xfind(this.selector).filter("[template]"):!0===this.filter.noTemplate?c.xfind(this.selector).not("[template], [template] *"):c.xfind(this.selector);!0===this.filter.noEmpty?a=a.filter(function(){h=$(this).text();return 0===$(this).children().length&&0<$.trim(h).length}):!0===this.filter.onlyLeaf&&(a=a.filter(function(){return 0===
$(this).children().length}));return a="undefined"!==typeof this.index&&null!==this.index?a.eq(this.index):a};b.prototype.setVal=function(a,h,b){var c,l;l=this.getVal().join(" ");a="undefined"!==typeof a?$.isArray(a)?a.join(" "):a:"";a=this.convert(a,b);c=this.get();if(1===c.length&&$.trim(a.toString())!==$.trim(l.toString()))return c.text(a),a=this.validate(h,b),e.trigger("dataupdate",c.prop("nodeName")),a;if(1<c.length)return console.error("nodeset.setVal expected nodeset with one node, but received multiple"),
null;0===c.length&&console.error("Data node: "+this.selector+" with null-based index: "+this.index+" not found!");return null};b.prototype.getVal=function(){var a=[];this.get().each(function(){a.push($(this).text())});return a};b.prototype.clone=function(a){var h,b;h=this.get();a=a||h;1===h.length&&1===a.length?(h.clone().insertAfter(a).find("*").andSelf().removeAttr("template"),b=[h.prop("nodeName")],h.find("*").each(function(){b.push($(this).prop("nodeName"))}),e.trigger("dataupdate",b.join())):
console.error("node.clone() function did not receive origin and target nodes")};b.prototype.remove=function(){var a=this.get();0<a.length?(a.remove(),e.trigger("dataupdate",a.prop("nodeName"))):console.error("could not find node "+this.selector+" with index "+this.index+"to remove ")};b.prototype.convert=function(a,h){return""===a.toString()?a:"undefined"!==typeof h&&null!==h&&"undefined"!==typeof this.types[h.toLowerCase()]&&"undefined"!==typeof this.types[h.toLowerCase()].convert?this.types[h.toLowerCase()].convert(a):
a};b.prototype.validate=function(a,h){var b,c;b=this.getVal();if(""===b.toString())return!0;if("undefined"==typeof h||null===h||"undefined"==typeof this.types[h.toLowerCase()])console.error("data type "+h+" set to string"),h="string";b=this.types[h.toLowerCase()].validate(b);c="undefined"!==typeof a&&null!==a&&0<a.length?d.evaluate(a,"boolean",this.selector,this.index):!0;return b&&c};b.prototype.types={string:{validate:function(){return!0}},select:{validate:function(){return!0}},select1:{validate:function(){return!0}},
decimal:{validate:function(a){return!isNaN(a-0)&&null!==a?!0:!1}},"int":{validate:function(a){return!isNaN(a-0)&&null!==a&&Math.round(a)==a?!0:!1}},date:{validate:function(a){return"Invalid Date"!==(new Date(a.toString())).toString()},convert:function(a){a=new Date(a);a.setUTCHours(0,0,0,0);return(new Date(a)).toUTCString()}},datetime:{validate:function(a){return"Invalid Date"!==(new Date(a)).toString()},convert:function(a){return(new Date(a)).toUTCString()}},time:{validate:function(a){return"Invalid Date"!==
(new Date("2012-01-01 "+a)).toString()},convert:function(a){a=new Date("2012-01-01 "+a);return a.getHours().toString().pad(2)+":"+a.getMinutes().toString().pad(2)+":"+a.getSeconds().toString().pad(2)}},barcode:{validate:function(){return!0}},geopoint:{validate:function(a){a=a.toString().split(" ");return""!==a[0]&&-90<=a[0]&&90>=a[0]&&""!==a[1]&&-180<=a[1]&&180>=a[1]&&!isNaN(a[2])&&("undefined"==typeof a[3]||!isNaN(a[3]))},convert:function(a){return $.trim(a.toString())}},binary:{validate:function(){return!0}}}}
function d(a){e=$(a)}var f,g,e,i;this.ex=function(a,b,c,e){return f.evaluate(a,b,c,e)};this.sfv=function(){return g.setAllVals()};this.getDataO=function(){return f.get()};this.data=function(a){return new c(a)};this.form=function(a){return new d(a)};this.getDataXML=function(){return f.getXML()};this.validateAll=function(){return g.validateAll()};this.init=function(){i=$(a).clone().appendTo("<original></original>");f=new c(b);f.init();g=new d(a);g.init()};this.getDataStr=function(a,b){return f.getStr(a,
b)};this.getRecordName=function(){return g.recordName.get()};this.setRecordName=function(a){return g.recordName.set(a)};this.getRecordStatus=function(){return g.recordStatus.get()};this.setRecordStatus=function(a){return g.recordStatus.set(a)};this.setEditStatus=function(a){return g.editStatus.set(a)};this.getEditStatus=function(){return g.editStatus.get()};this.getName=function(){return e.find("#form-title").text()};this.reset=function(){$("#form-languages").remove();e.replaceWith(i)};this.validateForm=
function(){return g.validateAll()};this.isValid=function(){return g.isValid()};this.prepareForSubmission=function(a){var b,l,d=new c(a);e.find('[data-type-xml="date"], [data-type-xml="dateTime"]').each(function(){b=$(this).attr("name");d.node(b).get().each(function(){console.debug("found date DATA node with name: "+b);l=$(this).text().trim();0<l.length&&(console.debug("converting date string: "+l),l=(new Date(l)).toJrString(),console.debug("jrDateString: "+l),$(this).text(l))})});e.find('[type="time"]').each(function(){});
return d.getStr(!0,!0)};c.prototype.init=function(){var a,b;this.node(null,null,{noEmpty:!0,noTemplate:!1}).get().each(function(){b=$(this).text();$(this).text($.trim(b))});a=this.node(":first",0).get();this.namespace=a.attr("xmlns");a.removeAttr("xmlns");this.cloneAllTemplates()};c.prototype.cloneTemplate=function(a,b){var c,e,d=this.node(a,0,{onlyTemplate:!0}),d=0===d.get().length?this.node(a,0):d;e=d.get().prop("nodeName");c=this.node(a,b).get();1===d.get().length&&1===c.length&&c.next().prop("nodeName")!==
e?d.clone(c):c.next().prop("nodeName")!==e&&console.error("Could not find template node and/or node to insert the clone after")};c.prototype.cloneAllTemplates=function(a){var b=this;if("undefined"==typeof a||0===a.length)a=this.$.find(":first");a.children("[template]").each(function(){"undefined"==typeof $(this).parent().attr("template")&&0===$(this).siblings($(this).prop("nodeName")).not("[template]").length&&$(this).clone().insertAfter($(this)).find("*").andSelf().removeAttr("template")});a.children().not("[template]").each(function(){b.cloneAllTemplates($(this))})};
c.prototype.get=function(){return this.$||null};c.prototype.getXML=function(){return this.xml||null};c.prototype.getStr=function(a,b){var c,a="undefined"!==typeof a?a:!1,b="undefined"!==typeof b?b:!0;c=$("<root></root");this.$.find(":first").clone().appendTo(c);!1===a&&c.find("[template]").remove();!0===b&&("undefined"!==typeof this.namespace&&0<this.namespace.length)&&c.children().eq(0).attr("xmlns",this.namespace);c=(new XMLSerializer).serializeToString(c.children().eq(0)[0]);c=c.replace(/xmlns\=\"[A-z0-9\:\/\.\-\%\_\?&amp;]*\"/gi,
" ");return c=c.replace(/\t/g,"")};c.prototype.makeBugCompliant=function(a,b){var c,e,d,f=a;for(c=0;c<b.length;c++)e=b.eq(c).attr("name"),d=b.eq(c).siblings('[name="'+e+'"]').andSelf().index(b.eq(c)),f=f.replace(e,e+"["+(d+1)+"]");return f};c.prototype.evaluate=function(a,b,d,f){var m,j,g,b=b||"any",f=f||0;m=new c(this.getStr(!1,!1));"undefined"!==typeof d&&null!==d?(m=m.node(d,f,{}).get()[0],0<e.find('[name="'+d+'"]').parents(".jr-repeat").length&&(d=e.find('[name="'+d+'"]').eq(f).parents(".jr-repeat"),
a=this.makeBugCompliant(a,d))):m=m.getXML();d={"0":["any","ANY_TYPE"],1:["number","NUMBER_TYPE","numberValue"],2:["string","STRING_TYPE","stringValue"],3:["boolean","BOOLEAN_TYPE","booleanValue"],7:["nodes","ORDERED_NODE_SNAPSHOT_TYPE"],9:["node","FIRST_ORDERED_NODE_TYPE"]};for(j in d)if(j=Number(j),d[j][0]==b)break;else j=0;a=a.replace(/&lt;/g,"<");a=a.replace(/&gt;/g,">");a=a.replace(/&quot;/g,'"');try{g=document.evaluate(a,m,null,j,null);if(0===j){for(j in d)if(j=Number(j),j==Number(g.resultType))return g=
0<j&&4>j?g[d[j][2]]:g,console.debug("evaluated "+a+" to: "+g),g;console.error("Expression: "+a+" did not return any boolean, string or number value as expected")}console.debug("evaluated "+a+" to: "+g[d[j][2]]);return g[d[j][2]]}catch(i){return console.error("Error occurred trying to evaluate: "+a+", message: "+i.message),null}};d.prototype.init=function(){var a;this.checkForErrors();if("undefined"==typeof f||!(f instanceof c))return console.error("variable data needs to be defined as instance of DataXML");
e.find('label>input[type="checkbox"], label>input[type="radio"]').parent().parent("fieldset").prepend('<div class="question-icons"><span class="required"></span><span class="hint"></span></div>');e.parent().find("label>select, , label>textarea, :not(#jr-preload-items, #jr-calculated-items)>label>input").not('[type="checkbox"], [type="radio"]').parent().prepend('<div class="question-icons"><span class="required"></span><span class="hint"></span></div>');e.find('label>input[type="checkbox"][required], label>input[type="radio"][required]').parent().parent("fieldset").find("legend:eq(0)").append('<span class="required">*</span>');
e.parent().find("label>select[required], label>textarea[required], :not(#jr-preload-items, #jr-calculated-items)>label>input[required]").not('[type="checkbox"], [type="radio"]').parent().each(function(){$(this).children("span:not(.jr-option-translations):last").after('<span class="required">*</span>')});e.find('input[type="radio"]').each(function(){a=$(this).attr("name");$(this).attr("data-name",a)});e.find("h2").first().append("<span/>");this.repeat.init();this.setAllVals();this.beautify();this.widgets.init();
this.branch.init();this.calcUpdate();this.outputUpdate();this.setEventHandlers();this.preloads.init();this.setLangs();this.editStatus.set(!1);setTimeout(function(){e.fixLegends()},500)};d.prototype.checkForErrors=function(){var a,b=[],c,d,g,j,i,n,k,t,u,q,p,r,o,y,z,A,w,x;k=e.find("#stats");a=parseInt(k.find('[id="jrItem"]').text(),10);c=parseInt(k.find('[id="jrInput"]').text(),10);d=parseInt(k.find('[id="jrUpload"]').text(),10);g=parseInt(k.find('[id="jrTrigger"]').text(),10);j=parseInt(k.find('[id="jrConstraint"]').text(),
10);i=parseInt(k.find('[id="jrRelevant"]').text(),10);n=parseInt(k.find('[id="jrCalculate"]').text(),10);k=parseInt(k.find('[id="jrPreload"]').text(),10);t=e.find('input[type="radio"]').length;u=e.find('input[type="checkbox"]').length;e.find("select");q=e.find('option[value!=""]').length;p=e.find('textarea, input:not([type="radio"],[type="checkbox"])').length;r=e.find(".trigger").length;o=e.find('[data-relevant]:not([type="radio"],[type="checkbox"])').length;y=e.find('input[data-relevant][type="radio"],input[data-relevant][type="checkbox"]').parent().parent("fieldset").length;
z=e.find('[data-constraint]:not([type="radio"],[type="checkbox"])').length;A=e.find('input[data-constraint][type="radio"],input[data-constraint][type="checkbox"]').parent().parent("fieldset").length;w=e.find("[data-calculate]").length;x=e.find("#jr-preload-items input").length;a!==q+t+u&&console.error(" total select-type filter differs between XML form and HTML form");c+d!==p-w-x&&console.error(" total amount of input/upload fields differs between XML form and HTML form");g!=r&&console.error(" total triggers differs between XML form and HTML form");
i!=o+y&&console.error(" total amount of branches differs between XML form and HTML form (not a problem if caused by obsolete bindings in xml form)");j!=z+A&&console.error(" total amount of constraints differs between XML form and HTML form (not a problem if caused by obsolete bindings in xml form). Note that constraints on &lt;trigger&gt; elements are ignored in the transformation and could cause this error too.");n!=w&&console.error(" total amount of calculated items differs between XML form and HTML formprel");
k!=x&&console.error(" total amount of preload items differs between XML form and HTML form");e.find("[name]").each(function(){$.inArray($(this).attr("name"),b)&&b.push($(this).attr("name"))});for(a=0;a<b.length;a++)1>f.node(b[a]).get().length&&console.error("Found name attribute: "+b[a]+" that does not have a corresponding data node. Transformation error or XML form error (relative nodesets perhaps?")};d.prototype.input={getWrapNodes:function(a){var b=this.getInputType(a.eq(0));return"radio"==b||
"checkbox"==b?a.parent("label").parent("fieldset"):"fieldset"==b?a:a.parent("label")},getProps:function(a){return 1!==a.length?console.error("getProps(): no input node provided or multiple"):{path:this.getName(a),ind:this.getIndex(a),inputType:this.getInputType(a),xmlType:this.getXmlType(a),constraint:a.attr("data-constraint"),relevant:a.attr("data-relevant"),val:this.getVal(a),required:void 0!==a.attr("required")?!0:!1,enabled:this.isEnabled(a),multiple:this.isMultiple(a)}},getInputType:function(a){return 1!==
a.length?"":"input"==a.prop("nodeName").toLowerCase()?0<a.attr("type").length?a.attr("type").toLowerCase():console.error("<input> node has no type"):"select"==a.prop("nodeName").toLowerCase()?"select":"textarea"==a.prop("nodeName").toLowerCase()?"textarea":"fieldset"==a.prop("nodeName").toLowerCase()?"fieldset":console.error("unexpected input node type provided")},getXmlType:function(a){return 1!==a.length?console.error("getXMLType(): no input node provided or multiple"):a.attr("data-type-xml")},
getName:function(a){return 1!==a.length?console.error("getName(): no input node provided or multiple"):"radio"==this.getInputType(a)?a.attr("data-name"):0<a.attr("name").length?a.attr("name"):console.error("input node has no name")},getIndex:function(a){var b,c,d;if(1!==a.length)return console.error("getIndex(): no input node provided or multiple");b=this.getInputType(a);c=this.getName(a);d=this.getWrapNodes(a);return("radio"===b&&c!==a.attr("name")?this.getWrapNodes(e.find('[data-name="'+c+'"]')):
this.getWrapNodes(e.find('[name="'+c+'"]'))).index(d)},isMultiple:function(a){return"checkbox"==this.getInputType(a)||void 0!==a.attr("multiple")?!0:!1},isEnabled:function(a){return void 0!==a.attr("disabled")||0!==a.parents("fieldset:disabled").length?!1:!0},getVal:function(a){var b,c=[],e;if(1!==a.length)return console.error("getVal(): no inputNode provided or multiple");b=this.getInputType(a);e=this.getName(a);return"radio"==b?this.getWrapNodes(a).find("input:checked").val()||"":"checkbox"==b?
(this.getWrapNodes(a).find('input[name="'+e+'"]:checked').each(function(){c.push($(this).val())}),c):a.val()||""},setVal:function(a,b,c){b=b||0;if("radio"==this.getInputType(e.find('[data-name="'+a+'"]').eq(0)))return this.getWrapNodes(e.find('[data-name="'+a+'"]')).eq(b).find('input[value="'+c+'"]').attr("checked",!0);a=this.getWrapNodes(e.find('[name="'+a+'"]')).eq(b).find("input, select, textarea");!0===this.isMultiple(a.eq(0))&&(c=c.split(" "));return a.val(c)}};d.prototype.setAllVals=function(){var a,
b,c,e=this;f.node(null,null,{noEmpty:!0}).get().each(function(){c=$(this).text();a=f.node($(this).prop("nodeName")).get().index($(this));b=e.generateName($(this));e.input.setVal(b,a,c)})};d.prototype.setLangs=function(){var a,b,c,d=this,f=e.find("#form-languages").attr("data-default-lang");$("#form-languages").detach().insertBefore($("form.jr").parent());if(!f||""===f)f=$("#form-languages a:eq(0)").attr("lang");console.debug("default language is: "+f);2>$("#form-languages a").length?(e.find("[lang]").addClass("active"),
e.find(".jr-form-short.active").each(function(){0<$(this).siblings(".jr-form-long.active").length&&$(this).removeClass("active")}),this.setHints()):($("#form-languages a").click(function(f){f.preventDefault();a=$(this).attr("lang");$("#form-languages a").removeClass("active");$(this).addClass("active");e.find("[lang]").removeClass("active").filter('[lang="'+a+'"], [lang=""]').addClass("active");e.find(".jr-form-short.active").each(function(){0<$(this).siblings(".jr-form-long.active").length&&$(this).removeClass("active")});
e.find("select>option").not('[value=""]').each(function(){b=$(this).attr("value");c=$(this).parent("select").next(".jr-option-translations").children('.active[data-option-value="'+b+'"]').text().trim();c="undefined"!==typeof c&&0<c.length?c:"[MISSING TRANSLATION]";$(this).text(c)});e.find("legend span.active:not(.jr-hint, .jr-constraint-msg), label span.active:not(.jr-hint, .jr-constraint-msg)").each(function(){0===$(this).text().trim().length&&$(this).text("[MISSING TRANSLATION]")});d.setHints();
e.trigger("changelanguage")}),$('#form-languages a[lang="'+f+'"]').click())};d.prototype.setHints=function(){var a,b;e.find("*>.jr-hint").parent().each(function(){b="label"!==$(this).prop("nodeName").toLowerCase()&&"fieldset"!==$(this).prop("nodeName").toLowerCase()?$(this).parent("fieldset"):$(this);a=0<b.length?$(this).find(".jr-hint.active").text().trim():$(this).find("span.jr-hint").text().trim();0<a.length?b.find(".question-icons .hint").attr("title",a).addClass("ui-icon ui-icon-help"):b.find(".question-icons .hint").removeAttr("title").removeClass("ui-icon ui-icon-help")});
e.tooltip()};d.prototype.editStatus={set:function(a){e.attr("data-edited",Boolean(a));e.trigger("edit",a)},get:function(){return"true"===e.attr("data-edited")?!0:!1}};d.prototype.recordName={set:function(a){e.attr("data-stored-with-key",a);e.find("h2 span").text(a)},get:function(){return e.attr("data-stored-with-key")||null},reset:function(){e.removeAttr("data-stored-with-key")}};d.prototype.recordStatus={set:function(a){e.attr("data-stored-final",a.toString())},get:function(){return"true"===e.attr("data-stored-final")?
!0:!1},reset:function(){e.removeAttr("data-stored-final")}};d.prototype.branch={init:function(){e.on("click",".jr-branch",function(){var a=$(this);$(this).hasClass("busy")||($(this).hasClass("show")?$(this).addClass("busy").removeClass("show").next().hide("blind",{},600,function(){a.removeClass("busy")}):$(this).addClass("busy show").next().show("blind",{},600,function(){a.removeClass("busy");a.next().fixLegends()}))});this.update()},update:function(a){var b,c,d,m,j,i={},n=this;m="undefined"!==typeof a?
a.split(","):[];j=0<m.length?[]:["[data-relevant]"];for(a=0;a<m.length;a++)j.push('[data-relevant*="'+m[a]+'"]');console.debug("Updating branches for expressions that contain: "+m.join());e.find(j.join()).each(function(){b=g.input.getProps($(this));c=g.input.getWrapNodes($(this));if(!("radio"==b.inputType||"checkbox"==b.inputType)||!i[b.path])if(console.debug("properties of branch input node:"),console.debug(b),1!==c.length)console.error("could not find branch node");else{try{d=f.evaluate(b.relevant,
"boolean",b.path,b.ind)}catch(a){console.error('Serious error occurred trying to evaluate skip logic for node with name: "'+b.path+'" (message: '+a.message+")");return}i[b.path]=!0;!0===d?n.enable(c):n.disable(c)}});return!0},enable:function(a){console.debug("enabling branch");a.prev(".jr-branch").hide("slow",function(){$(this).remove()});a.removeClass("disabled").show("blind",{direction:"up"},1E3,function(){$(this).fixLegends()});return"label"==a.prop("nodeName").toLowerCase()?a.children("input, select, textarea").removeAttr("disabled"):
a.removeAttr("disabled")},disable:function(a){console.debug("disabling branch");a.addClass("disabled").hide();0===a.prev(".jr-branch").length&&(a.before('<div class="jr-branch"></div>'),a.clearInputs("change"));return"label"==a.prop("nodeName").toLowerCase()?a.children("input, select, textarea").attr("disabled","disabled"):a.attr("disabled","disabled")}};d.prototype.outputUpdate=function(a){var b,c,d,g="";console.log("updating active outputs that contain: "+a);c="undefined"!==typeof a?a.split(","):
[];d=0<c.length?[]:[".jr-output[data-value]"];for(a=0;a<c.length;a++)d.push('.jr-output[data-value*="'+c[a]+'"]');e.find(":not([disabled]) span.active").find(d.join()).each(function(){try{b=$(this).attr("data-value"),g=f.evaluate(b,"string")}catch(a){console.error("error occurred trying to evaluate output value from expression: "+b+", (message:"+a.message+")"),g="[ERROR]"}$(this).text(g)});e.fixLegends();this.setHints()};d.prototype.calcUpdate=function(a){var b,c,d,g,j,i,n;i="undefined"!==typeof a?
a.split(","):[];n=0<i.length?[]:["input[data-calculate]"];for(a=0;a<i.length;a++)n.push('input[data-calculate*="'+i[a]+'"]');e.find("#jr-calculated-items").find(n.join()).each(function(){b=$(this).attr("name");c=$(this).attr("data-calculate");d=$(this).attr("data-type-xml");j=$(this).attr("data-constraint");g=f.evaluate(c,"string",b,null);f.node(b,null).setVal(g,j,d)})};d.prototype.beautify=function(){e.find(".trigger").addClass("ui-state-highlight");$("fieldset:not(.jr-appearance-compact)>label, fieldset:not(.jr-appearance-compact)>legend").children("img,video,audio").parent().addClass("ui-helper-clearfix with-media")};
d.prototype.widgets={init:function(){this.compactWidget();this.radioWidget();this.dateWidget();this.timeWidget();this.dateTimeWidget();this.selectOneWidget();this.selectMultiWidget();this.pageBreakWidget();this.readonlyWidget();this.gridWidget();this.spinnerWidget();this.sliderWidget();this.geopointWidget();this.barcodeWidget();this.fileWidget()},compactWidget:function(){e.find(".jr-appearance-compact>label>span").hide()},radioWidget:function(){},dateWidget:function(){Modernizr.inputtypes.date||e.find('input[type="date"]').datepicker({})},
timeWidget:function(){Modernizr.inputtypes.time||e.find('input[type="time"]').timepicker({})},dateTimeWidget:function(){Modernizr.inputtypes.datetime||e.find('input[type="datetime"]').datetimepicker()},selectOneWidget:function(){e.find("select:not([multiple])").attr("size","1");$("select:not([multiple])").multiselect({multiple:!1,header:"Select one option",noneSelectedText:"Select one option",selectedList:1,position:{my:"left top",at:"left bottom"}})},selectMultiWidget:function(){e.find("select[multiple]").attr("size",
"5").find('[value=""]').remove();$("select[multiple]").multiselect({header:"false",position:{my:"left top",at:"left bottom"}})},pageBreakWidget:function(){e.find(".jr-appearance-page-break input[readonly]").parent("label").each(function(){var a='name="'+$(this).find("input").attr("name")+'"';$('<fieldset class="jr-appearance-page-break" '+a+"></fieldset>").insertBefore($(this)).find("input").remove();$(this).remove()})},readonlyWidget:function(){e.find('input[readonly]:not([data-type-xml="geopoint"])').parent("label").each(function(){var a=
$(this).html(),b=$(this).find("input").attr("data-relevant"),c='name="'+$(this).find("input").attr("name")+'"';$('<fieldset class="trigger ui-state-highlight" '+("undefined"!==typeof b?'data-relevant="'+b+'" '+c:c)+"></fieldset>").insertBefore($(this)).append(a).find("input").remove();$(this).remove()})},gridWidget:function(){},spinnerWidget:function(){},sliderWidget:function(){},geopointWidget:function(){console.log("initializing geopoint widget");e.find('input[data-type-xml="geopoint"]').each(function(){function a(b,
d,h){"undefined"!==typeof google.maps.LatLng&&(u={zoom:h||15,center:new google.maps.LatLng(b,d),mapTypeId:google.maps.MapTypeId.ROADMAP,streetViewControl:!1},q=new google.maps.Map(t[0],u),c(),google.maps.event.addListener(q,"click",function(a){e(a.latLng.lat(),a.latLng.lng(),"","","change.bymap");c(a.latLng)}))}function b(){window.setTimeout(function(){q.panTo(p.getPosition())},5E3)}function c(a){a=a||q.getCenter();"undefined"!==typeof p&&p.setMap(null);p=new google.maps.Marker({position:a,map:q,
draggable:!0});google.maps.event.addListener(p,"dragend",function(){e(p.getPosition().lat(),p.getPosition().lng(),"","","change.bymap");b()});b()}function e(a,b,c,h,l){c=c||"";h=h||"";l=l||"change";d.val(Math.round(1E4*a)/1E4);f.val(Math.round(1E4*b)/1E4);g.val(Math.round(10*c)/10);i.val(Math.round(10*h)/10).trigger(l)}var d,f,g,i,k,t,u,q,p,r=$(this),o=$(this).parent("label");o.addClass("geopoint");r.hide().after('<div class="map-canvas"></div><label>latitude (x.y &deg;)<input name="lat" type="number" step="0.0001" /></label><label>longitude (x.y &deg;)<input name="long" type="number" step="0.0001" /></label><label>altitude (m)<input name="alt" type="number" step="0.1" /></label><label>accuracy (m)<input name="acc" type="number" step="0.1" /></label><button name="geodetect" type="button">detect</button>');
t=o.find(".map-canvas");d=o.find('[name="lat"]');f=o.find('[name="long"]');g=o.find('[name="alt"]');i=o.find('[name="acc"]');k=o.find('button[name="geodetect"]');o.find("input").not(r).on("change change.bymap",function(b){console.debug("change event dected");var c=""!==d.val()?d.val():0,e=""!==f.val()?f.val():0,l=""!==g.val()?g.val():0,s=i.val();r.val(c+" "+e+" "+l+" "+s).trigger("change");"bymap"!==b.namespace&&a(c,e);return!1});navigator.geolocation||k.attr("disabled","disabled");"undefined"!==
typeof google&&"undefined"!==typeof google.maps&&a(0,0,1);k.click(function(b){b.preventDefault();console.debug("click event detected");console.debug(b);navigator.geolocation.getCurrentPosition(function(b){a(b.coords.latitude,b.coords.longitude);e(b.coords.latitude,b.coords.longitude,b.coords.altitude,b.coords.accuracy)});return!1}).click()})},autoCompleteWidget:function(){},barcodeWidget:function(){},fileWidget:function(){e.find('input[type="file"]').attr("placeholder","not supported yet").attr("disabled",
"disabled")}};d.prototype.preloads={init:function(){var a,b,c,d,g=this;e.find("#jr-preload-items input").each(function(){a=$(this).attr("data-preload").toLowerCase();b=$(this).attr("data-preload-params").toLowerCase();c=$(this).attr("name");"undefined"!==typeof g[a]?(d=f.node(c).getVal(),g.setVal($(this),g[a]({param:b,curVal:d,node:$(this)}))):console.error('Preload "'+a+'"" not supported. May or may not be a big deal.')})},setVal:function(a,b){a.val(b.toString()).trigger("change")},timestamp:function(a){var b=
this;return"start"==a.param&&""!==a.curVal?""===a.curVal?a.curVal:f.evaluate("now()","string"):"end"==a.param?(e.on("beforesave",function(){b.setVal(a.node,f.evaluate("now()","string"))}),f.evaluate("now()","string")):""},date:function(a){var b,c;return""!==a.curVal?(b=new Date(f.evaluate("today()","string")),a=b.getUTCFullYear().toString().pad(4),c=(b.getUTCMonth()+1).toString().pad(2),b=b.getUTCDate().toString().pad(2),a+"-"+c+"-"+b):a.curVal},property:function(){return"no device properties in enketo"},
context:function(a){return"application"==a.param?"enketo":""},patient:function(){return"patient preload not supported in enketo"},user:function(){return"user preload item not functioning yet"},uid:function(){return"no uid yet in enketo"},browser:function(a){if("name"==a.param)return $.browser.webkit?"webkit":$.browser.mozilla?"mozilla":$.browser.opera?"opera":$.browser.msie?"msie":"unknown";if("version"==a.param)return $.browser.version},os:function(){return"not known"}};d.prototype.repeat={init:function(){var a,
b,c,d,g,i=this;e.find("fieldset.jr-repeat").prepend('<span class="repeat-number"></span>');e.find("fieldset.jr-repeat:not([data-repeat-fixed])").append('<button type="button" class="repeat"></button><button type="button" class="remove"></button>');e.find("button.repeat").button({text:!1,icons:{primary:"ui-icon-plusthick"}});e.find("button.remove").button({disabled:!0,text:!1,icons:{primary:"ui-icon-minusthick"}});e.on("click","button.repeat:enabled",function(){i.clone($(this).parent("fieldset.jr-repeat"));
return!1});e.on("click","button.remove:enabled",function(){i.remove($(this).parent("fieldset.jr-repeat.clone"));return!1});e.find("fieldset.jr-repeat").each(function(){c=$(this).attr("data-repeat-count")||"";b=0<c.length?parseInt(f.node(c).getVal(),10):0;d=f.node($(this).attr("name")).get().length;g=b>d?b:d;for(a=1;a<g;a++)i.clone($(this).siblings().andSelf().last(),"")})},clone:function(a,b){var c,d,g,i,v,n,k=this;if(1!==a.length)return console.error("Nothing to clone"),!1;c=a.parent("fieldset.jr-group").children("fieldset.jr-repeat:not(.clone)").eq(0);
d=c.clone(!1);d.find(".clone").remove();d.addClass("clone");d.find("button.remove").button({text:!1,icons:{primary:"ui-icon-minusthick"}});d.find("button.repeat").button({text:!1,icons:{primary:"ui-icon-plusthick"}});d.insertAfter(a).parent(".jr-group").numberRepeats();d.hide().show("highlight",{},600);d.clearInputs(b);d.find(".invalid input, .invalid select, .invalid textarea").each(function(){k.setValid($(this))});g=e.find('fieldset.jr-repeat[name="'+a.attr("name")+'"]').index(a);i=[];d.find('input[type="radio"]').each(function(){-1===
$.inArray($(this).attr("data-name"),i)&&i.push($(this).attr("data-name"))});for(v=0;v<i.length;v++)n=(new Date).getTime().toString(),d.find('input[type="radio"][data-name="'+i[v]+'"]').attr("name",n);this.toggleButtons(c.parent());c=c.attr("name");0<c.length&&0<=g&&f.cloneTemplate(c,g);e.trigger("changerepeat");return!0},remove:function(a){var b=this,c=a.attr("name"),d=e.find('[name="'+c+'"]').index(a),g=a.parent("fieldset.jr-group");a.hide("drop",{},600,function(){a.remove();g.numberRepeats();b.toggleButtons(g)});
f.node(c,d).remove();e.trigger("changerepeat")},toggleButtons:function(a){a="undefined"==typeof a||0===a.length||!a?a=e:a;a.find("button.repeat, button.remove").button("disable").removeClass("ui-state-hover");a.find("fieldset.jr-repeat:last-child > button.repeat").button("enable");a.find("fieldset.jr-repeat:not(:nth-child(2)) > button.remove").button("enable")}};d.prototype.setEventHandlers=function(){var a,b,c=this;$("form.jr").attr("onsubmit","return false;");e.on("change validate","input, select, textarea",
function(d){a=c.input.getProps($(this));b="validate"==d.type?a.enabled&&"hidden"!==a.inputType?f.node(a.path,a.ind).validate(a.constraint,a.xmlType):!0:f.node(a.path,a.ind).setVal(a.val,a.constraint,a.xmlType);b=a.enabled&&"hidden"!==a.inputType&&a.required&&1>a.val.length?!1:b;if("undefined"!==typeof b&&null!==b)return!1===b?c.setInvalid($(this)):c.setValid($(this))});e.on("dataupdate",function(a,b){c.calcUpdate(b);c.branch.update(b);c.outputUpdate(b)});e.on("change changerepeat",function(){c.editStatus.set(!0)});
e.on("changerepeat",function(){c.setAllVals()});$(window).resize(function(){e.fixLegends()});e.on("changelanguage",function(){c.outputUpdate()})};d.prototype.setValid=function(a){this.input.getWrapNodes(a).removeClass("invalid ui-state-error")};d.prototype.setInvalid=function(a){this.input.getWrapNodes(a).addClass("invalid ui-state-error")};d.prototype.generateName=function(a){for(var b=[a.prop("nodeName")],a=a.parent();1==a.length&&"#document"!==a.prop("nodeName");)b.push(a.prop("nodeName")),a=a.parent();
return"/"+b.reverse().join("/")};d.prototype.validateAll=function(){var a=this;e.find("fieldset:disabled input, fieldset:disabled select, fieldset:disabled textarea, input:disabled, select:disabled, textarea:disabled").each(function(){a.setValid($(this))});e.find("input, select, textarea").trigger("validate");return this.isValid()};d.prototype.isValid=function(){return 0<e.find(".invalid").length?!1:!0}}GUI.prototype.setCustomEventHandlers=function(){};
Date.prototype.toJrString=function(){var a,b=this.getUTCFullYear().toString().pad(4)+"-"+(this.getUTCMonth()+1).toString().pad(2)+"-"+this.getUTCDate().toString().pad(2);if(0<this.getUTCMilliseconds()||0<this.getUTCSeconds()||0<this.getUTCMinutes()||0<this.getUTCHours())b+="T"+this.getHours().toString().pad(2)+":"+this.getMinutes().toString().pad(2)+":"+this.getSeconds().toString().pad(2)+"."+this.getMilliseconds().toString().pad(3),a=this.getTimezoneOffset()/60,b+=0>a?"+"+(-a).toString().pad(2):
"-"+a.toString().pad(2);return b};
(function(a){a.fn.numberRepeats=function(){return this.each(function(){a(this).find("fieldset.jr-repeat").each(function(){var b,c,d;0===a(this).prev("fieldset.jr-repeat").length&&(b=a(this).siblings("fieldset.jr-repeat"),c=b.length+1,1<c?(a(this).find("span.repeat-number").text("1"),d=2,b.each(function(){a(this).find("span.repeat-number").text(d);d++})):a(this).find("span.repeat-number").empty())})})};a.fn.clearInputs=function(b){b=b||"edit";return this.each(function(){a(this).find("input, select, textarea").each(function(){var c=a(this).attr("type");
"SELECT"===a(this).prop("nodeName").toUpperCase()&&(c="select");"TEXTAREA"===a(this).prop("nodeName").toUpperCase()&&(c="textarea");switch(c){case "date":case "number":case "search":case "color":case "range":case "url":case "email":case "password":case "text":case "file":case "hidden":case "textarea":a(this).val("").trigger(b);break;case "radio":case "checkbox":a(this).prop("checked")&&(a(this).prop("checked",!1),a(this).trigger(b));break;case "select":a(this)[0].selectedIndex=-1;a(this).trigger(b);
break;default:console.error("Unrecognized input type found when trying to reset: "+c)}})})};a.fn.fixLegends=function(){var b;return this.each(function(){a(this).find("legend + label").each(function(){b=0<a(this).prev().find(".jr-constraint-msg.active").length&&36>a(this).prev().height()?36:19>a(this).prev().height()?19:a(this).prev().height();a(this).animate({"margin-top":b+6+"px"},600)})})};a.fn.xfind=function(a){var c,d,a=a.replace(/\/\//g," "),a=a.replace(/^\//,""),a=a.replace(/\/\.$/,""),a=a.replace(/\//g,
">"),a=a.replace(/\[([^@].*?)\]/g,function(a,b){return":has("+b+")"});if(0<=a.indexOf(">..")){a=a.split(/>\.\.>?/g);c=jQuery(a[0],this);for(d=1;d<a.length;d++)c=c.parent(a[d]);return c.get()}return this.find(a)}})(jQuery);/*
 Copyright 2012 Martijn van de Rijdt

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
*/
var form,connection,cache,settings,currentOnlineStatus=!1,store,MODERN_BROWSERS_URL="modern_browsers",CACHE_CHECK_INTERVAL=36E4,DEFAULT_SETTINGS={autoUpload:!0,buttonLocation:"bottom",autoNotifyBackup:!1};
$(document).ready(function(){var a,b,c;store=new StorageLocal;form=new Form("form.jr:eq(0)",jrDataStr);settings=new Settings;settings.init();connection=new Connection;store.isSupported()?$(document).trigger("browsersupport","local-storage"):window.location=MODERN_BROWSERS_URL;cache=new Cache;gui.updateStatus.offlineLaunch(!1);$("html").attr("manifest")&&(cache.isSupported()?(b=(a=store.getRecord("__bookmark"))?a.shown:0,3>b&&setTimeout(function(){c=1===b?"time":"times";gui.showFeedback("Please bookmark this page for easy offline launch. This reminder will be shown "+
(2-b)+" more "+c+".",20);b++;store.setRecord("__bookmark",{shown:b})},5E3),cache.init(),$(document).trigger("browsersupport","offline-launch")):(a={posButton:"Show options",negButton:"Use it",posAction:function(){window.location=MODERN_BROWSERS_URL}},gui.confirm({msg:"Offline application launch not supported by your browser. You can use the form without this feature or see options for resolving this",heading:"Application cannot launch offline"},a)));form.init();connection.init();gui.setup();$("form.jr").trigger("save",
JSON.stringify(store.getFormList()))});
function loadForm(a,b){var c;!b&&form.getEditStatus()?(c={posAction:function(){loadForm(a,!0)}},gui.confirm("Would you like to proceed without saving changes to the form you were working on?",c)):(c=store.getRecord(a),null!==c.data?(form.reset(),form=new Form("form.jr:eq(0)",c.data),form.init(),form.setRecordName(a),$("#page-close").click(),$("button#delete-form").button("enable"),gui.showFeedback('"'+a+'" has been loaded',2)):gui.alert("Record contained no data"))}
function saveForm(a,b,c,d){var f;f=form.getRecordName();var g=form.getRecordStatus(),e={};console.debug("new name: "+a+", before: "+f+", delOld: "+c+", overwr: "+d);if(null===form.getDataStr(!0,!0)||""===form.getDataStr(!0,!0))return gui.showFeedback("Nothing to save.");if("undefined"==typeof a||0===a.length)return f=f||store.getCounterValue(),$('#dialog-save input[name="record-name"]').val(f),$('#dialog-save input[name="record-final"]').attr("checked",g),gui.saveConfirm();if(f&&f!==a&&"undefined"==
typeof c)return d={posButton:"Yes, delete",negButton:"No, keep",posAction:function(){saveForm(a,b,!0)},negAction:function(){saveForm(a,b,!1)}},gui.confirm({msg:"Record name has changed. Would you like to delete the record saved under the old name:"+f+"?",heading:"Delete old Record?"},d);$("form.jr").trigger("beforesave");e={data:form.getDataStr(!0,!0),ready:b};console.debug("sending following record to store.setRecord():");console.debug(e);f=store.setRecord(a,e,c,d,f);console.log("result of save: "+
f);"success"===f?(gui.showFeedback('Form with name "'+a+'" has been saved.',2),form.setRecordName(a),form.setRecordStatus(b),form.setEditStatus(!1),$("button#delete-form").button("enable"),$("form.jr").trigger("save",JSON.stringify(store.getFormList()))):"existing"===f?(d={posButton:"Yes, overwrite",posAction:function(){saveForm(a,b,c,!0)},negAction:function(){gui.showFeedback("Form was not saved.")}},gui.confirm("Record with name "+a+" already exists. Would you like to overwrite existing record? ",
d)):"forbidden"===f?(gui.alert("This name is not allowed. Please change it"),gui.showFeedback("Form was NOT saved.")):gui.showFeedback("Error occurred. Form was NOT saved.")}
function resetForm(a){console.debug("editstatus: "+form.getEditStatus());!a&&form.getEditStatus()?(a={posAction:function(){resetForm(!0)}},gui.confirm("There are unsaved changes, would you like to continue <strong>without</strong> saving those?",a)):(form.reset(),form=new Form("form.jr:eq(0)",jrDataStr),form.init(),$("button#delete-form").button("disable"))}
function deleteForm(a){var b=form.getRecordName();""!==b&&null!==b?a?store.removeRecord(b)?(resetForm(!0),gui.showFeedback("Successfully deleted form."),$("form.jr").trigger("delete",JSON.stringify(store.getFormList()))):gui.showFeedback("An error occurred when trying to delete this form."):(a={posButton:"Delete",posAction:function(){deleteForm(!0)}},gui.confirm("Please confirm that you would like to remove this form from storage.",a)):gui.showFeedback("Please first load the form you would like to delete or choose reset if you'd like to reset the current form.")}
function submitForm(){var a;form.isValid()?(a={data:form.getDataStr(!0,!0),ready:!0},a=store.setRecord(form.getName()+" - "+store.getCounterValue(),a,!1,!1),console.log("result of save: "+a),"success"===a?(connection.upload(!0),resetForm(!0),$("form.jr").trigger("save",JSON.stringify(store.getFormList()))):gui.alert("Error trying to save data locally before submit")):gui.alert("Form contains errors <br/>(please see fields marked in red)")}
function exportData(a){var b;b=store.getSurveyDataOnlyArr(a||!0);if(0===b.length)gui.showFeedback("No data to export.");else{for(a=0;a<b.length;a++)b[a]=form.prepareForSubmission(b[a]);a=vkbeautify.xml("<exported>"+b.join("")+"</exported>");a="data:application/octet-stream,"+encodeURIComponent(a);window.open(a,"exportedData")}}
function exportToFile(a,b){var c,d,b=b||!0,a=a||form.getName()+"_data_backup.xml";d=store.getSurveyDataOnlyArr(b);if(!d||0===d.length)gui.showFeedback('No data marked "final" to export.');else{for(c=0;c<d.length;c++)d[c]=form.prepareForSubmission(d[c]);c=vkbeautify.xml("<exported>"+d.join("")+"</exported>");d=new BlobBuilder;d.append(c);c=d.getBlob("application/octet-stream; charset=utf-8");saveAs(c,a)}}function Cache(){}
Cache.prototype.init=function(){var a=this;if(!this.isSupported)return!1;0<applicationCache.status&&5>applicationCache.status&&gui.updateStatus.offlineLaunch(!0);if(applicationCache.status===applicationCache.UPDATEREADY)this.onUpdateReady();if(applicationCache.status===applicationCache.OBSOLETE)this.onObsolete();applicationCache.addEventListener("obsolete",this.onObsolete,!1);applicationCache.addEventListener("cached",this.onCached,!1);applicationCache.addEventListener("updateready",this.onUpdateReady,
!1);applicationCache.addEventListener("error",this.onErrors,!1);setInterval(function(){a.update()},CACHE_CHECK_INTERVAL);(applicationCache.status===applicationCache.UNCACHED||applicationCache.status===applicationCache.IDLE)&&this.update()};Cache.prototype.update=function(){applicationCache.update()};Cache.prototype.onObsolete=function(){gui.showFeedback("Application/form is no longer able to launch offline.");gui.updateStatus.offlineLaunch(!1)};
Cache.prototype.onCached=function(){gui.showFeedback("Congratulations! This form can now be loaded when you are offline.");gui.updateStatus.offlineLaunch(!0)};Cache.prototype.onUpdateReady=function(){applicationCache.swapCache();gui.showFeedback("A new version of this application or form has been downloaded. Refresh this page to load the updated version.",20)};Cache.prototype.onErrors=function(a){console.error("HTML5 cache error event");console.debug(a);gui.showFeedback("There is a new version of this application or form available but an error occurs when trying to download it. Please send a bug report.")};
Cache.prototype.isSupported=function(){return window.applicationCache?!0:!1};function Connection(){var a=this;this.uploadOngoing=!1;this.init=function(){a=this;window.setInterval(function(){a.upload()},15E3);$(window).on("offline online",function(){console.log("window network event detected");a.setOnlineStatus(a.getOnlineStatus())});$(window).trigger("online")}}Connection.prototype.getOnlineStatus=function(){console.log("checking connection status");return navigator.onLine};
Connection.prototype.setOnlineStatus=function(a){a!==this.currentOnlineStatus&&(console.log("status changed to: "+a+", triggering window.onlinestatuschange"),$(window).trigger("onlinestatuschange",a));this.currentOnlineStatus=a};Connection.prototype.switchCache=function(a){"boolean"!==typeof a?console.error("switchCache called without parameter"):$.ajax("webform/switch_cache",{type:"POST",data:{cache:a}})};
Connection.prototype.upload=function(a,b){var c="true"===settings.getOne("autoUpload")||!0===settings.getOne("autoUpload")?!0:!1;if(!1===this.uploadOngoing&&(!0===c||a)){this.uploadResult={win:[],fail:[]};this.uploadQueue=store.getSurveyDataArr(!0,b);this.forced=a;console.debug("upload queue: "+this.uploadQueue);if(0===this.uploadQueue.length)return a?gui.showFeedback('Nothing marked "final" to upload (or record is currently open).'):!1;this.uploadOne()}else this.forced=!0===a?!0:this.forced};
Connection.prototype.uploadOne=function(){var a,b,c,d=this;0<this.uploadQueue.length&&(this.uploadOngoing=!0,a=this.uploadQueue.pop(),b=new FormData,b.append("xml_submission_data",form.prepareForSubmission(a.data)),b.append("Date",(new Date).toUTCString()),c=0===this.uploadQueue.length?!0:!1,this.setOnlineStatus("waiting"),$.ajax("data/submission",{type:"POST",data:b,cache:!1,contentType:!1,processData:!1,timeout:8E3,complete:function(b){d.processOpenRosaResponse(b.status,a.name,c);d.uploadOne()}}))};
Connection.prototype.processOpenRosaResponse=function(a,b,c){var d,f="";d=[];var g={"0":{success:!1,msg:"Uploading of data failed (probably offline)"},200:{success:!1,msg:"Data server did not accept data. Contact Enketo helpdesk please."},201:{success:!0,msg:""},202:{success:!0,msg:b+" may have had errors. Contact survey administrator please."},"2xx":{success:!1,msg:"Unknown error occurred when submitting data. Contact Enketo helpdesk please"},400:{success:!1,msg:"Data server did not accept data. Contact survey administrator please."},
403:{success:!1,msg:"You are not allowed to post data to this data server. Contact survey administrator please."},404:{success:!1,msg:"Submission area on data server not found or not properly configured."},"4xx":{success:!1,msg:"Unknown submission problem on data server."},413:{success:!1,msg:"Data is too large. Please export the data and contact the Enketo helpdesk please."},500:{success:!1,msg:"Sorry, the Enketo server is down or being maintained. Please try again later or contact Enketo helpdesk please."},
503:{success:!1,msg:"Sorry, the Enketo server is down or being maintained. Please try again later or contact Enketo helpdesk please."},"5xx":{success:!1,msg:"Sorry, the Enketo server is down or being maintained. Please try again later or contact Enketo helpdesk please."}};"undefined"!==typeof g[a]?!0===g[a].success?(store.removeRecord(b),$("form.jr").trigger("delete",JSON.stringify(store.getFormList())),console.log("tried to remove record with key: "+b),this.uploadResult.win.push([b,g[a].msg])):!1===
g[a].success&&this.uploadResult.fail.push([b,g[a].msg]):500<a?(console.error("Error during uploading, received unexpected statuscode: "+a),this.uploadResult.fail.push([b,g["5xx"].msg])):400<a?(console.error("Error during uploading, received unexpected statuscode: "+a),this.uploadResult.fail.push([b,g["4xx"].msg])):200<a&&(console.error("Error during uploading, received unexpected statuscode: "+a),this.uploadResult.fail.push([b,g["2xx"].msg]));if(!0===c){console.debug("going to provide upload feedback (forced = "+
this.forced+") from object:");console.debug(this.uploadResult);if(0<this.uploadResult.win.length){for(a=0;a<this.uploadResult.win.length;a++)d.push(this.uploadResult.win[a][0]),f="undefined"!==typeof this.uploadResult.win[a][2]?f+this.uploadResult.win[a][1]+" ":"";a=1<a?" were":" was";d=d.join(", ");gui.showFeedback(d.substring(0,d.length)+a+" successfully uploaded. "+f);this.setOnlineStatus(!0)}if(0<this.uploadResult.fail.length&&(console.debug("upload failed"),this.setOnlineStatus(!1),$(".drawer.left #status").text("Offline."),
!0===this.forced)){for(a=0;a<this.uploadResult.fail.length;a++)f+=this.uploadResult.fail[a][0]+": "+this.uploadResult.fail[a][1]+"<br />";console.debug("going to give upload feedback to user");0<$(".drawer.left").length?$(".drawer.left.hide .handle").click():gui.alert(f,"Failed data submission")}this.uploadOngoing=!1}};Settings.prototype.autoUpload=function(){};Settings.prototype.buttonLocation=function(a){$("#form-controls").removeClass("bottom right mobile").addClass(a);$(window).trigger("resize")};
GUI.prototype.setCustomEventHandlers=function(){var a=this;$("button#save-form").button({icons:{primary:"ui-icon-disk"}}).click(function(){form.validateForm();saveForm()});$("button#reset-form").button({icons:{primary:"ui-icon-refresh"}}).click(function(){resetForm()});$("button#delete-form").button({icons:{primary:"ui-icon-trash"},disabled:!0}).click(function(){deleteForm(!1)});$("button#submit-form").button({icons:{primary:"ui-icon-check"}}).click(function(){form.validateForm();submitForm();return!1});
$("#drawer-export").click(function(){exportToFile();return!1});$(".drawer.left .handle.right").click(function(){var a=$(this).parent(".drawer");console.debug("clicked handle");a.toggleClass("hide")});$("#form-controls button").equalWidth();$(document).on("click","#records-saved li:not(.no-click)",function(a){a.preventDefault();a=$(this).find(".name").text();loadForm(a);$(this).siblings().removeClass("ui-state-active");$(this).addClass("ui-state-active")}).on("mouseenter","#records-saved li:not(.no-click)",
function(){$(this).addClass("ui-state-hover")}).on("mouseleave","#records-saved li:not(.no-click)",function(){$(this).removeClass("ui-state-hover")});this.pages().get("records").find("button#records-force-upload").button({icons:{primary:"ui-icon-arrowthick-1-n"}}).click(function(){connection.upload(!0,form.getRecordName())}).hover(function(){$("#records-force-upload-info").show()},function(){$("#records-force-upload-info").hide()});this.pages().get("records").find("button#records-export").button({icons:{primary:"ui-icon-suitcase"}}).click(function(){exportData(!1)}).hover(function(){$("#records-export-info").show()},
function(){$("#records-export-info").hide()});$(document).on("save delete","form.jr",function(b,c){console.debug("save or delete event detected with new formlist: "+c);a.updateRecordList(JSON.parse(c))});$(document).on("setsettings",function(b,c){a.setSettings(c)});this.pages().get("settings").on("change","input",function(){var a=$(this).attr("name"),c=$(this).is(":checked")?$(this).val().toString():"";console.debug("settings change by user detected");settings.set(a,c)});$("#dialog-save").hide()};
GUI.prototype.updateRecordList=function(a,b){var c,d,f,g,e,i=0,h=0;console.debug("updating recordlist in GUI");b||(b=this.pages().get("records"));e=b.find("#records-saved ol");e.children().remove();a=a||[];if(0<a.length){for(f=0;f<a.length;f++)c=a[f].key,d=(new Date(a[f].lastSaved)).toDateString(),a[f].ready?(g="check",i++):(g="pencil",h++),d=$('<li><span class="ui-icon ui-icon-'+g+'"></span><span class="name"></span><span class="date"> ('+d+")</span></li>"),d.find(".name").text(c),e.append(d);$("#queue-length").text(a.length)}else $('<li class="no-click">no locally saved records found</li>').appendTo(e),
$("#queue-length").text("0");b.find("#records-draft-qty").text(h);b.find("#records-final-qty").text(i)};
GUI.prototype.saveConfirm=function(){var a=$("#dialog-save");this.confirm({dialog:"save",msg:"",heading:"Record Details"},{posButton:"Ok",negButton:"Cancel",posAction:function(){console.debug("value of final in confirm dialog: "+Boolean(a.find('[name="record-final"]:checked').val()));return saveForm(a.find('[name="record-name"]').val(),Boolean(a.find('[name="record-final"]:checked').val()))},negAction:function(){return!1},beforeAction:function(){form.isValid()?(console.log("form valid"),a.find('[name="record-final"]').removeAttr("disabled")):
(console.log("form invalid"),a.find('[name="record-final"]').attr("disabled","disabled"))}})};