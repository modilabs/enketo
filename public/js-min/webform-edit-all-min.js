/*
 Copyright 2012 Martijn van de Rijdt

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
*/
var gui,printO;$(document).ready(function(){gui=new GUI;gui.init();"undefined"==typeof console&&(console={log:function(){}});"undefined"==typeof window.console.debug&&(console.debug=console.log);"true"!==getGetVariable("debug")&&(window.console.log=function(){},window.console.debug=function(){});"true"==getGetVariable("touch")?(Modernizr.touch=!0,$("html").addClass("touch")):"false"==getGetVariable("touch")&&(Modernizr.touch=!1,$("html").removeClass("touch"));printO=new Print});function GUI(){}
GUI.prototype.init=function(){this.nav.setup();this.pages.init();this.setEventHandlers();"function"===typeof this.setCustomEventHandlers&&this.setCustomEventHandlers();$(".dialog [title]").tooltip({});Modernizr.borderradius&&(Modernizr.boxshadow&&Modernizr.csstransitions&&Modernizr.opacity)&&$(document).trigger("browsersupport","fancy-visuals");$("footer").detach().appendTo("#container");this.display()};GUI.prototype.setup=function(){$(window).trigger("resize")};
GUI.prototype.setEventHandlers=function(){var a=this;$(document).on("click","#feedback-bar .close",function(){a.hideFeedback();return!1});$(document).on("click",".touch #feedback-bar",function(){a.hideFeedback()});$(document).on("click","#page .close",function(){a.pages.close();return!1});$(document).on("click",'a[href^="#"]:not([href="#"]):not(nav ul li a)',function(a){var c=$(this).attr("href");console.log("captured click to nav page, href="+c);"#"!==c&&(a.preventDefault(),$('nav li a[href="'+c+
'"]').click())});$('nav ul li a[href^="#"]').click(function(b){b.preventDefault();b=$(this).attr("href").substr(1);a.pages.open(b);$(this).closest("li").addClass("active").siblings().removeClass("active")});$(window).on("onlinestatuschange",function(b,c){a.updateStatus.connection(c)});$(document).on("edit","form.jr",function(b,c){a.updateStatus.edit(c)});$(document).on("browsersupport",function(b,c){a.updateStatus.support(c)});$("#page, #feedback-bar").on("change",function(){a.display()})};
GUI.prototype.nav={setup:function(){$("article.page").each(function(){var a,b="",c;c=$(this).attr("id");a=$(this).attr("data-display")?$(this).attr("data-display"):c;b=$(this).attr("data-title")?$(this).attr("data-title"):c;c=$(this).attr("data-ext-link")?$(this).attr("data-ext-link"):"#"+c;$('<li class=""><a href="'+c+'" title="'+b+'" >'+a+"</a></li>").appendTo($("nav ul"))})},reset:function(){$("nav ul li").removeClass("active")}};
GUI.prototype.pages={init:function(){this.$pages=$("<pages></pages>");$("article.page").detach().appendTo(this.$pages)},get:function(a){var b=this.$pages.find('article[id="'+a+'"]');return b=0<b.length?b:$('article[id="'+a+'"]')},isShowing:function(a){return 0<$("#page article.page"+("undefined"!==typeof a?'[id="'+a+'"]':"")).length},open:function(a){this.isShowing(a)||(a=this.get(a),1!==a.length?console.error("page not found"):(this.isShowing()&&this.close(),$("#page .content").prepend(a.show()).trigger("change"),
$(window).bind("resize.pageEvents",function(){$("#page").trigger("change")})))},close:function(){var a=$("#page .page").detach();0<a.length&&(this.$pages.append(a),$("#page").trigger("change"),$("nav ul li").removeClass("active"),$("#overlay").hide(),$("#overlay, header").unbind(".pageEvents"),$(window).unbind(".pageEvents"))}};
GUI.prototype.showFeedback=function(a,b){var c,b=b?1E3*b:1E4;$("#feedback-bar p").eq(1).remove();$("#feedback-bar p").html()!==a&&(c=$("<p></p>"),c.append(a),$("#feedback-bar").append(c));$("#feedback-bar").trigger("change");setTimeout(function(){typeof c!=="undefined"&&c.remove();$("#feedback-bar").trigger("change")},b)};GUI.prototype.hideFeedback=function(){$("#feedback-bar p").remove();$("#feedback-bar").trigger("change")};
GUI.prototype.alert=function(a,b,c){var e=$("#dialog-alert"),c=c||"error",c="normal"===c?"":"alert alert-block alert-"+c;e.find(".modal-header h3").text(b||"Alert");e.find(".modal-body p").removeClass().addClass(c).html(a).capitalizeStart();e.modal({keyboard:!0,show:!0});e.on("hidden",function(){e.find(".modal-header h3, .modal-body p").html("")})};
GUI.prototype.confirm=function(a,b){var c,e,d,g,h;"string"===typeof a?c=a:"string"===typeof a.msg&&(c=a.msg);c="undefined"!==typeof c?c:"Please confirm action";e="undefined"!==typeof a.heading?a.heading:"Are you sure?";d="undefined"!==typeof a.errorMsg?a.errorMsg:"";g="undefined"!==typeof a.dialog?a.dialog:"confirm";b="undefined"!==typeof b?b:{};b.posButton=b.posButton||"Confirm";b.negButton=b.negButton||"Cancel";b.posAction=b.posAction||function(){return false};b.negAction=b.negAction||function(){return false};
b.beforeAction=b.beforeAction||function(){};h=$("#dialog-"+g);h.find(".modal-header h3").text(e);h.find(".modal-body .msg").html(c).capitalizeStart();h.find(".modal-body .alert-error").html(d);h.modal({keyboard:!0,show:!0});h.on("shown",function(){b.beforeAction.call()});h.find("button.positive").on("click",function(){b.posAction.call();h.modal("hide")}).text(b.posButton);h.find("button.negative").on("click",function(){b.negAction.call();h.modal("hide")}).text(b.negButton);h.on("hide",function(){h.off("shown hidden hide");
h.find("button.positive, button.negative").off("click")});h.on("hidden",function(){h.find(".modal-body .msg, .modal-body .alert-error, button").text("")})};
GUI.prototype.updateStatus={connection:function(a){console.log("updating online status in menu bar to:");console.log(a);!0===a?($("header #status-connection").removeClass().addClass("ui-icon ui-icon-signal-diag").attr("title","It appears there is currently an Internet connection available."),$(".drawer #status").removeClass("offline waiting").text("")):!1===a?($("header #status-connection").removeClass().addClass("ui-icon ui-icon-cancel").attr("title","It appears there is currently no Internet connection"),
$(".drawer #status").removeClass("waiting").addClass("offline").text("Offline. ")):$(".drawer #status").removeClass("offline").addClass("waiting").text("Waiting. ")},edit:function(a){a?$("header #status-editing").removeClass().addClass("ui-icon ui-icon-pencil").attr("title","Form is being edited."):$("header #status-editing").removeClass().attr("title","")},support:function(){},offlineLaunch:function(a){$(".drawer #status-offline-launch").text(a?"Offline Launch: Yes":"Offline Launch: No")}};
GUI.prototype.fillHeight=function(a){var b=$(window).height(),c=$("header").outerHeight(!0),a=a.outerHeight()-a.height();return b-c-a};
GUI.prototype.display=function(){var a,b;b=$("header");var c=$("#feedback-bar"),e=$("#page");0<c.find("p").length?(a="fixed"===b.css("position")?b.outerHeight():0,b=this.pages.isShowing()?b.outerHeight()+c.outerHeight():0-e.outerHeight()):(a="fixed"===b.css("position")?b.outerHeight()-c.outerHeight():0-c.outerHeight(),b=this.pages.isShowing()?b.outerHeight():0-e.outerHeight());c.css("top",a);e.css("top",b)};
GUI.prototype.setSettings=function(a){var b,c=this;console.log("gui updateSettings() started");$.each(a,function(a,d){b=d?c.pages.get("settings").find('input[name="'+a+'"][value="'+d+'"]'):c.pages.get("settings").find('input[name="'+a+'"]');0<b.length&&b.attr("checked",d?!0:!1).trigger("change")})};
GUI.prototype.parseFormlist=function(a,b,c){var e,d="";if($.isEmptyObject(a))b.addClass("empty"),c||(d='<p class="alert alert-error">Error occurred during creation of form list or no forms found</p>');else{for(e in a)d+='<li><a class="btn btn-block btn-info" id="'+e+'" title="'+a[e].title+'" href="'+a[e].url+'" data-server="'+a[e].server+'" >'+a[e].name+"</a></li>";b.removeClass("empty")}b.find("ul").empty().append(d)};
function getGetVariable(a){for(var b=window.location.search.substring(1).split("&"),c=0;c<b.length;c++){var e=b[c].split("=");if(e[0]==a)return encodeURI(e[1])}return!1}function Print(){this.setStyleSheet();this.setDpi()}Print.prototype.setDpi=function(){var a,b=document.body.appendChild(document.createElement("DIV"));b.style.width="1in";b.style.padding="0";a=b.offsetWidth;b.parentNode.removeChild(b);this.dpi=a};
Print.prototype.setStyleSheet=function(){this.styleSheet=this.getStyleSheet();this.$styleSheetLink=$('link[media="print"]:eq(0)')};Print.prototype.getStyleSheet=function(){for(var a=0;a<document.styleSheets.length;a++)if("print"===document.styleSheets[a].media.mediaText)return document.styleSheets[a];return null};Print.prototype.styleToAll=function(){this.styleSheet||this.setStyleSheet();this.styleSheet.media.mediaText="all";this.$styleSheetLink.attr("media","all")};
Print.prototype.styleReset=function(){this.styleSheet.media.mediaText="print";this.$styleSheetLink.attr("media","print")};Print.prototype.printForm=function(){console.debug("preparing form for printing");this.removePageBreaks();this.removePossiblePageBreaks();this.styleToAll();this.addPageBreaks();this.styleReset();window.print()};Print.prototype.removePageBreaks=function(){$(".page-break").remove()};Print.prototype.removePossiblePageBreaks=function(){$(".possible-break").remove()};
Print.prototype.addPossiblePageBreaks=function(){var a=$("<hr>",{"class":"possible-break"});this.removePossiblePageBreaks();$("form.jr").before(a.clone()).after(a.clone()).find("fieldset>legend, label:not(.geo)>input:not(input:radio, input:checkbox), label>select, label>textarea, .trigger>*, h4>*, h3>*").parent().each(function(){var b,c;b=$(this);return(c=b.prev().get(0))&&("H3"===c.nodeName||"H4"===c.nodeName)||$(c).hasClass("repeat-number")||0<b.parents("#jr-calculated-items, #jr-preload-items").length?
null:b.before(a.clone())});$(".possible-break").each(function(){if($(this).prev().hasClass("possible-break"))return $(this).remove()})};
Print.prototype.addPageBreaks=function(){var a,b,c,e,d,g,h,i;h=9.5*this.dpi;e=function(a,c){this.begin=$(a);this.begin_top=this.begin.offset().top;this.end=$(c);this.end_top=this.end.offset().top;this.h=this.end_top-this.begin_top;if(0>this.h)throw console.debug("begin (top: "+this.begin_top+")",a),console.debug("end (top: "+this.end_top+")",c),Error("A question group has an invalid height.");};e.prototype.break_before=function(){var a,c;c=(a=this.begin.prev().get(0))?["after",a]:["before",this.begin.parent().get(0)];
a=c[0];return $(c[1])[a]("<hr class='page-break' />")};this.removePageBreaks();this.addPossiblePageBreaks();c=$(".possible-break");b=[];for(a=1;a<c.length;a++)b.push(new e(c[a-1],c[a]));e=0;c=[];a=[];g=0;for(i=b.length;g<i;g++)d=b[g],e+d.h>h?(a.push(c),c=[d],e=d.h):(c.push(d),e+=d.h);a.push(c);console.debug("pages: ",a);h=1;for(c=a.length;h<c;h++)b=a[h],0<b.length&&b[0].break_before();return $(".possible-break").remove()};
(function(a){a.fn.toLargestWidth=function(){var b=0;return this.each(function(){a(this).width()>b&&(b=a(this).width())}).each(function(){a(this).width(b)})};a.fn.toSmallestWidth=function(){var b=2E3;return this.each(function(){console.log(a(this).width());a(this).width()<b&&(b=a(this).width())}).each(function(){a(this).width(b)})};a.fn.reverse=[].reverse;a.fn.alphanumeric=function(b){b=a.extend({ichars:"!@#$%^&*()+=[]\\';,/{}|\":<>?~`.- ",nchars:"",allow:""},b);return this.each(function(){b.nocaps&&
(b.nchars+="ABCDEFGHIJKLMNOPQRSTUVWXYZ");b.allcaps&&(b.nchars+="abcdefghijklmnopqrstuvwxyz");for(var c=b.allow.split(""),e=0;e<c.length;e++)-1!=b.ichars.indexOf(c[e])&&(c[e]="\\"+c[e]);b.allow=c.join("|");var d=b.ichars+b.nchars,d=d.replace(RegExp(b.allow,"gi"),"");a(this).keypress(function(a){var c;c=a.charCode?String.fromCharCode(a.charCode):String.fromCharCode(a.which);d.indexOf(c)!=-1&&a.preventDefault();a.ctrlKey&&c=="v"&&a.preventDefault()});a(this).bind("contextmenu",function(){return false})})};
a.fn.numeric=function(b){var c="abcdefghijklmnopqrstuvwxyz",c=c+c.toUpperCase(),b=a.extend({nchars:c},b);return this.each(function(){a(this).alphanumeric(b)})};a.fn.alpha=function(b){b=a.extend({nchars:"1234567890"},b);return this.each(function(){a(this).alphanumeric(b)})};a.fn.capitalizeStart=function(a){a||(a=1);var c=this.contents().filter(function(){return 3==this.nodeType}).first(),e=c.text(),a=e.split(" ",a).join(" ");c.length&&(c[0].nodeValue=e.slice(a.length),c.before('<span class="capitalize">'+
a+"</span>"))}})(jQuery);/*
 Copyright 2012 Martijn van de Rijdt

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
*/
function StorageLocal(){function a(a){var c;for(c=0;c<b.length;c++)if(a===b[c])return!0;return!1}var b="__settings null __history Firebug undefined __bookmark __counter __current_server".split(" "),c=window.localStorage;this.isSupported=function(){try{return"localStorage"in window&&null!==window.localStorage}catch(a){return!1}};this.getForbiddenKeys=function(){return b};this.setRecord=function(b,d,g,h,i){if(!b||1>b.length)return console.error("no key provided for record"),"require";b=b.trim();i="string"===
typeof i?i.trim():null;h="undefined"!==typeof h&&!0===h?!0:!1;if("string"===typeof d.data&&a(b))return"forbidden";var f;if(f="string"===typeof d.data)if(f=i!==b)f=c.getItem(b)?!0:!1,f=f&&!0!==h;if(f)return"existing";try{return"string"===typeof d.data&&(d.lastSaved=(new Date).getTime(),c.setItem("__counter",JSON.stringify({counter:this.getCounterValue()}))),c.setItem(b,JSON.stringify(d)),console.debug("saved: "+b+", old key was: "+i),null!==i&&(""!==i&&i!==b)&&g&&(console.log("going to remove old record with key:"+
i),this.removeRecord(i)),"success"}catch(q){return console.log("error in store.setRecord:"+q.message),"error"}};this.getRecord=function(a){var b;try{return b=JSON.parse(c.getItem(a))}catch(g){return console.error("error with loading data from store: "+g.message),null}};this.removeRecord=function(a){try{return c.removeItem(a),$("form.jr").trigger("delete",JSON.stringify(this.getRecordList())),!0}catch(b){return console.log("error with removing data from store: "+b.message),!1}};this.getFormList=function(a){return"undefined"==
typeof a?null:this.getRecord("__server_"+a)};this.getRecordList=function(){var a,c,b=[],h=this.getSurveyRecords(!1);for(a=0;a<h.length;a++)c=h[a],b.push({key:c.key,ready:c.ready,lastSaved:c.lastSaved});console.debug("formList returning "+b.length+" items");b.sort(function(a,c){return c.lastSaved-a.lastSaved});return b};this.getSurveyRecords=function(b,d){var g,h,i=[],f={},b=b||!1,d=d||null;for(g=0;g<c.length;g++)if(h=c.key(g),f=this.getRecord(h),!a(h))try{f.key=h,h!==d&&(!b||"true"===f.ready||!0===
f.ready)&&i.push(f)}catch(q){console.log("record found that was probably not in the correct JSON format (e.g. Firebug settings or corrupt record) (error: "+q.message+"), record was ignored")}return i};this.getSurveyDataArr=function(a,c){var b,h,i=[];h=this.getSurveyRecords(a||!0,c);for(b=0;b<h.length;b++)i.push({name:h[b].key,data:h[b].data});return i};this.getSurveyDataOnlyArr=function(a){for(var c=this.getSurveyDataArr(a),b=[],a=0;a<c.length;a++)b.push(c[a].data);return 0<b.length?b:null};this.getCounterValue=
function(){var a=this.getRecord("__counter");return((a&&"undefined"!==typeof a.counter&&isNumber(a.counter)?Number(a.counter):0)+1).toString().pad(4)}}function isNumber(a){return!isNaN(parseFloat(a))&&isFinite(a)};/*
 Copyright 2012 Martijn van de Rijdt & Modilabs

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
*/
function Form(a,b,c){function e(a){function c(a,j,l){this.originalSelector=a;this.selector="string"===typeof a&&0<a.length?a:"*";this.filter=l="undefined"!==typeof l&&null!==l?l:{};this.filter.noTemplate="undefined"!==typeof l.noTemplate?l.noTemplate:!0;this.filter.onlyLeaf="undefined"!==typeof l.onlyLeaf?l.onlyLeaf:!1;this.filter.onlyTemplate="undefined"!==typeof l.onlyTemplate?l.onlyTemplate:!1;this.filter.noEmpty="undefined"!==typeof l.noEmpty?l.noEmpty:!1;this.index=j;0<b.find("model>instance").length&&
(this.selector="*"!==this.selector&&0!==this.selector.indexOf("/")&&e.instanceSelectRegEx.test(this.selector)?this.selector.replace(e.instanceSelectRegEx,"model > instance#$1"):"model > instance:eq(0) "+this.selector)}var b,e=this;this.instanceSelectRegEx=/instance\([\'|\"]([^\/:\s]+)[\'|\"]\)/g;a=a.replace(/xmlns\=\"[a-zA-Z0-9\:\/\.]*\"/g,"");this.xml=$.parseXML(a);this.$=b=$(this.xml);XPathJS.bindDomLevel3XPath();this.node=function(a,j,b){return new c(a,j,b)};c.prototype.get=function(){var a,j;
a=!0===this.filter.onlyTemplate?b.xfind(this.selector).filter("[template]"):!0===this.filter.noTemplate?b.xfind(this.selector).not("[template], [template] *"):b.xfind(this.selector);!0===this.filter.noEmpty?a=a.filter(function(){j=$(this).text();return 0===$(this).children().length&&0<$.trim(j).length}):!0===this.filter.onlyLeaf&&(a=a.filter(function(){return 0===$(this).children().length}));return a="undefined"!==typeof this.index&&null!==this.index?a.eq(this.index):a};c.prototype.setVal=function(a,
j,c){var b,l;b=this.getVal()[0];l="undefined"!==typeof a&&null!==a?$.isArray(a)?a.join(" "):a.toString():"";l=this.convert(l,c);a=this.get();if(1===a.length&&$.trim(l.toString())!==$.trim(b.toString()))return a.text(l),j=this.validate(j,c),f.trigger("dataupdate",a.prop("nodeName")),j;if(1<a.length)return console.error("nodeset.setVal expected nodeset with one node, but received multiple"),null;0===a.length&&console.error("Data node: "+this.selector+" with null-based index: "+this.index+" not found!");
return null};c.prototype.getVal=function(){var a=[];this.get().each(function(){a.push($(this).text())});return a};c.prototype.clone=function(a){var j,c;j=this.get();a=a||j;1===j.length&&1===a.length?(j.clone().insertAfter(a).find("*").andSelf().removeAttr("template"),c=[j.prop("nodeName")],j.find("*").each(function(){c.push($(this).prop("nodeName"))}),f.trigger("dataupdate",c.join(","))):console.error("node.clone() function did not receive origin and target nodes")};c.prototype.remove=function(){var a=
this.get();0<a.length?(a.remove(),f.trigger("dataupdate",a.prop("nodeName"))):console.error("could not find node "+this.selector+" with index "+this.index+" to remove ")};c.prototype.convert=function(a,j){return""===a.toString()?a:"undefined"!==typeof j&&null!==j&&"undefined"!==typeof this.types[j.toLowerCase()]&&"undefined"!==typeof this.types[j.toLowerCase()].convert?this.types[j.toLowerCase()].convert(a):a};c.prototype.validate=function(a,j){var c,b;c=this.getVal()[0];if(""===c.toString())return!0;
if("undefined"==typeof j||null===j||"undefined"==typeof this.types[j.toLowerCase()])j="string";c=this.types[j.toLowerCase()].validate(c);b="undefined"!==typeof a&&null!==a&&0<a.length?e.evaluate(a,"boolean",this.originalSelector,this.index):!0;return c&&b};c.prototype.types={string:{validate:function(){return!0}},select:{validate:function(){return!0}},select1:{validate:function(){return!0}},decimal:{validate:function(a){return!isNaN(a-0)&&null!==a?!0:!1}},"int":{validate:function(a){return!isNaN(a-
0)&&null!==a&&Math.round(a)==a?!0:!1}},date:{validate:function(a){return(a=/([0-9]{4})([\-]|[\/])([0-9]{2})([\-]|[\/])([0-9]{2})/.exec(a))&&6===a.length?"Invalid Date"!==(new Date(Number(a[1]),Number(a[3])-1,Number(a[5]))).toString():!1},convert:function(a){var j=/([0-9]{4})([\-]|[\/])([0-9]{2})([\-]|[\/])([0-9]{2})/.exec(a),c=new Date(a);"Invalid Date"==(new Date(a)).toString()&&j&&(0<Number(j[1])&&0<=Number(j[3])&&12>Number(j[3])&&32>Number(j[5]))&&(c=new Date(Number(j[1]),Number(j[3])-1,Number(j[5])));
return c.getUTCFullYear().toString().pad(4)+"-"+(c.getUTCMonth()+1).toString().pad(2)+"-"+c.getUTCDate().toString().pad(2)}},datetime:{validate:function(a){console.debug("datetime validation function received: "+a+" type:"+typeof a);return"Invalid Date"!==(new Date(a.toString())).toString()},convert:function(a){var j=/([0-9]{4}\-[0-9]{2}\-[0-9]{2})([T]|[\s])([0-9]){2}:([0-9]){2}([0-9:.]*)(\+|\-)([0-9]{2}):([0-9]{2})$/,c=/([0-9]{4}\-[0-9]{2}\-[0-9]{2})([T]|[\s])([0-9]){2}:([0-9]){2}([0-9:.]*)(\+|\-)([0-9]{2})$/;
if("Invalid Date"!==(new Date(a)).toString()&&j.test(a))return a;if("Invalid Date"==(new Date(a)).toString()&&c.test(a))return a+":00";a=new Date(a);return"Invalid Date"!==a.toString()?a.toISOLocalString():a.toString()}},time:{validate:function(a){var j=new Date,a=a.toString().split(":");if(2>a.length)return!1;a[2]=a[2]?Number(a[2].toString().split(".")[0]):0;return 24>a[0]&&0<=a[0]&&60>a[1]&&0<=a[1]&&60>a[2]&&0<=a[2]&&"Invalid Date"!==j.toString()},convert:function(a){var j=a.toString().split(":");
$.each(j,function(a,c){j[a]=c.toString().pad(2)});return j.join(":")}},barcode:{validate:function(){return!0}},geopoint:{validate:function(a){a=a.toString().split(" ");return""!==a[0]&&-90<=a[0]&&90>=a[0]&&""!==a[1]&&-180<=a[1]&&180>=a[1]&&("undefined"==typeof a[2]||!isNaN(a[2]))&&("undefined"==typeof a[3]||!isNaN(a[3])&&0<=a[3])},convert:function(a){return $.trim(a.toString())}},binary:{validate:function(){return!0}}}}function d(a){this.$=f=$(a);this.branch=new this.Branch(this)}var g,h,i,f,q;this.ex=
function(a,c,b,e){return g.evaluate(a,c,b,e)};this.sfv=function(){return i.setAllVals()};this.data=function(a){return new e(a)};this.getDataO=function(){return g};this.getDataEditO=function(){return h.get()};this.form=function(a){return new d(a)};this.getFormO=function(){return i};this.init=function(){q=$(a).clone().appendTo("<original></original>");g=new e(b);i=new d(a);g.init();"undefined"!==typeof c&&0<c.length&&(h=new e(c),h.init(),g.load(h));i.init()};this.getDataStr=function(a,c,b){return g.getStr(a,
c,b)};this.getRecordName=function(){return i.recordName.get()};this.setRecordName=function(a){return i.recordName.set(a)};this.getRecordStatus=function(){return i.recordStatus.get()};this.setRecordStatus=function(a){return i.recordStatus.set(a)};this.setEditStatus=function(a){return i.editStatus.set(a)};this.getEditStatus=function(){return i.editStatus.get()};this.getName=function(){return f.find("#form-title").text()};this.resetHTML=function(){$("#form-languages").remove();f.replaceWith(q)};this.validateForm=
function(){return i.validateAll()};this.isValid=function(){return i.isValid()};e.prototype.init=function(){var a;this.node(null,null,{noEmpty:!0,noTemplate:!1}).get().each(function(){a=$(this).text();$(this).text($.trim(a))});this.cloneAllTemplates()};e.prototype.load=function(a){var c,b,e,d,g,h,n,o,k,m=this,p={noTemplate:!0,noEmpty:!0};c=a.node(null,null,p).get();console.debug("nodes to load: ",c);this.node(null,null,p).get().each(function(){$(this).text("")});c.each(function(){$(this).prop("nodeName");
d=i.generateName($(this));b=a.node(d).get().index($(this));g=$(this).text();n=f.find('[name="'+d+'"]').eq(0);e=0<n.length?i.input.getXmlType(n):"string";h=m.node(d,b);o=h.get();1<o.length?console.error("Found multiple nodes with path: "+d+" and index: "+b):1===o.length?h.setVal(g,null,e):0<m.node(d,b,{noTemplate:!1}).get().length?(k=m.node(d,0,{noTemplate:!1}).get().closest("[template]"),m.cloneTemplate(i.generateName(k),b-1),h=m.node(d,b),1===h.get().length?h.setVal(g,null,e):console.error("Error occured trying to clone template node to set the repeat value of the instance to be edited.")):
1===$(this).parent("meta").length?$(this).clone().appendTo(m.get().children().eq(0).children("meta")):console.error("did not find node with path: "+d+" and index: "+b+" so could not load data")});c=this.node("*>meta>instanceID");1!==c.get().length?console.error("instanceID was not found (or multiple)! Edited submission will not be successful."):(1!==this.node("*>meta>deprecatedID").get().length&&(p=$.parseXML("<deprecatedID/>").documentElement,$(p).appendTo(this.node("*>meta").get())),this.node("*>meta>deprecatedID").setVal(c.getVal()[0],
null,"string"),c.setVal("",null,"string"))};e.prototype.cloneTemplate=function(a,c){var b,e,d=this.node(a,0,{onlyTemplate:!0}),d=0===d.get().length?this.node(a,0):d;e=d.get().prop("nodeName");b=this.node(a,c).get();1===d.get().length&&1===b.length&&b.next().prop("nodeName")!==e?d.clone(b):b.next().prop("nodeName")!==e&&console.error("Could not find template node and/or node to insert the clone after")};e.prototype.cloneAllTemplates=function(a){var c=this;if("undefined"==typeof a||0===a.length)a=this.$.find(":first");
a.children("[template]").each(function(){"undefined"==typeof $(this).parent().attr("template")&&0===$(this).siblings($(this).prop("nodeName")).not("[template]").length&&$(this).clone().insertAfter($(this)).find("*").andSelf().removeAttr("template")});a.children().not("[template]").each(function(){c.cloneAllTemplates($(this))})};e.prototype.get=function(){return this.$||null};e.prototype.getXML=function(){return this.xml||null};e.prototype.getStr=function(a,c,b){a=a||!1;c=b?this.$.find(":first"):this.node("> :first").get();
b=$("<root></root");c.clone().appendTo(b);!1===a&&b.find("[template]").remove();a=(new XMLSerializer).serializeToString(b.children().eq(0)[0]);return a=a.replace(/\t/g,"")};e.prototype.makeBugCompliant=function(a,c,b){var e,d;e=0<f.find('[name="'+c+'"][type="radio"]').length&&0<b?"data-name":"name";d=i.input.getWrapNodes(f.find("["+e+'="'+c+'"]')).eq(b).parents(".jr-repeat");for(c=0;c<d.length;c++)b=d.eq(c).attr("name"),e=d.eq(c).siblings('[name="'+b+'"]').andSelf().index(d.eq(c)),console.log("calculated repeat 0-based index: "+
e),a=a.replace(b,b+"["+(e+1)+"]");return a};e.prototype.evaluate=function(a,c,b,d){var g,h,r,i,o,k,m,p;console.debug("evaluating expr: "+a+" with context selector: "+b+", 0-based index: "+d+" and result type: "+c);c=c||"any";d=d||0;a=a.trim();r=new e(this.getStr(!1,!1));if(this.instanceSelectRegEx.test(a)){i=a.match(this.instanceSelectRegEx);for(g=0;g<i.length;g++)o=i[g].match(/[\'|\"]([^\'']+)[\'|\"]/)[1],a=a.replace(i[g],'/node()/instance[@id="'+o+'"]'),this.$.find("instance#"+o).clone().appendTo(r.$.find(":first"))}"undefined"!==
typeof b&&null!==b?(console.debug("contextNode: ",r.$.xfind(b).eq(d)),g=r.$.xfind(b).eq(d)[0],0<f.find('[name="'+b+'"]').parents(".jr-repeat").length&&(a=this.makeBugCompliant(a,b,d))):g=r.getXML();b={"0":["any","ANY_TYPE"],1:["number","NUMBER_TYPE","numberValue"],2:["string","STRING_TYPE","stringValue"],3:["boolean","BOOLEAN_TYPE","booleanValue"],7:["nodes","ORDERED_NODE_SNAPSHOT_TYPE"],9:["node","FIRST_ORDERED_NODE_TYPE"]};for(k in b)if(k=Number(k),b[k][0]==c)break;else k=0;a=a.replace(/&lt;/g,
"<");a=a.replace(/&gt;/g,">");a=a.replace(/&quot;/g,'"');console.log("expr to test: "+a+" with result type number: "+k);try{m=document.evaluate(a,g,null,k,null);if(0===k){for(k in b)if(k=Number(k),k==Number(m.resultType))return m=0<k&&4>k?m[b[k][2]]:m,console.debug("evaluated "+a+" to: ",m),m;console.error("Expression: "+a+" did not return any boolean, string or number value as expected")}else if(7===k){p=$();for(h=0;h<m.snapshotLength;h++)p=p.add(m.snapshotItem(h));return p}console.debug("evaluated "+
a+" to: "+m[b[k][2]]);return m[b[k][2]]}catch(s){return console.error("Error occurred trying to evaluate: "+a+", message: "+s.message),null}};d.prototype.init=function(){var a;this.checkForErrors();if("undefined"==typeof g||!(g instanceof e))return console.error("variable data needs to be defined as instance of DataXML");f.find('label>input[type="checkbox"][required], label>input[type="radio"][required]').parent().parent("fieldset").find("legend:eq(0) span:not(.jr-hint):last").after('<span class="required">*</span>');
f.parent().find("label>select[required], label>textarea[required], :not(#jr-preload-items, #jr-calculated-items)>label>input[required]").not('[type="checkbox"], [type="radio"]').parent().each(function(){$(this).children("span:not(.jr-option-translations, .jr-hint):last").after('<span class="required">*</span>')});Modernizr.touch||(f.find(".jr-hint ~ input, .jr-hint ~ select, .jr-hint ~ textarea").before('<span class="hint" ><i class="icon-question-sign"></i></span>'),f.find("legend > .jr-hint").parent().find("span:last-child").after('<span class="hint" ><i class="icon-question-sign"></i></span>'),
f.find(".trigger > .jr-hint").parent().find("span:last").after('<span class="hint" ><i class="icon-question-sign"></i></span>'));f.find('select, input:not([type="checkbox"], [type="radio"]), textarea').before($("<br/>"));f.find('input[type="radio"]').each(function(){a=$(this).attr("name");$(this).attr("data-name",a)});f.find("h2").first().append("<span/>");this.repeat.init();this.itemsetUpdate();this.setAllVals();this.widgets.init();this.bootstrapify();this.branch.init();this.grosslyViolateStandardComplianceByIgnoringCertainCalcs();
this.calcUpdate();this.outputUpdate();this.setEventHandlers();this.preloads.init();this.setLangs();this.editStatus.set(!1)};d.prototype.checkForErrors=function(){var a,c=[],b,e,d,h,i,n,o,k,m,p,s,q,t,x,y,z,A,B,u,v;k=f.find("#stats");if(0<k.length){a=parseInt(k.find('[id="jrItem"]').text(),10);b=parseInt(k.find('[id="jrInput"]').text(),10);e=parseInt(k.find('[id="jrItemset"]').text(),10);d=parseInt(k.find('[id="jrUpload"]').text(),10);h=parseInt(k.find('[id="jrTrigger"]').text(),10);i=parseInt(k.find('[id="jrConstraint"]').text(),
10);n=parseInt(k.find('[id="jrRelevant"]').text(),10);o=parseInt(k.find('[id="jrCalculate"]').text(),10);k=parseInt(k.find('[id="jrPreload"]').text(),10);m=f.find('input[type="radio"]').length;p=f.find('input[type="checkbox"]').length;f.find("select");s=f.find(".itemset-template").length;q=f.find('option[value!=""]').length;t=f.find('textarea, input:not([type="radio"],[type="checkbox"])').length;x=f.find(".trigger").length;y=f.find('[data-relevant]:not([type="radio"],[type="checkbox"])').length;z=
f.find('input[data-relevant][type="radio"],input[data-relevant][type="checkbox"]').parent().parent("fieldset").length;A=f.find('[data-constraint]:not([type="radio"],[type="checkbox"])').length;B=f.find('input[data-constraint][type="radio"],input[data-constraint][type="checkbox"]').parent().parent("fieldset").length;u=f.find("[data-calculate]").length;v=f.find("#jr-preload-items input").length;0===e&&a!==q+m+p&&console.error(" total number of select fields differs between XML form and HTML form");
e!==s&&console.error(" total number of itemset fields differs between XML form ("+e+") and HTML form ("+s+")");b+d!==t-u-v&&console.error(" total number of input/upload fields differs between XML form and HTML form");h!=x&&console.error(" total number of triggers differs between XML form and HTML form");n!=y+z&&console.error(" total number of branches differs between XML form and HTML form (not a problem if caused by obsolete bindings in xml form)");i!=A+B&&console.error(" total numberRepeats of constraints differs between XML form and HTML form (not a problem if caused by obsolete bindings in xml form). Note that constraints on &lt;trigger&gt; elements are ignored in the transformation and could cause this error too.");
o!=u&&console.error(" total number of calculated items differs between XML form and HTML form");k!=v&&console.error(" total number of preload items differs between XML form and HTML form");f.find("[name]").each(function(){$.inArray($(this).attr("name"),c)&&c.push($(this).attr("name"))});for(a=0;a<c.length;a++)1>g.node(c[a]).get().length&&console.error("Found name attribute: "+c[a]+" that does not have a corresponding data node. Transformation error or XML form error (relative nodesets perhaps?")}};
d.prototype.input={getWrapNodes:function(a){var c=this.getInputType(a.eq(0));return"radio"==c||"checkbox"==c?a.parent("label").parent("fieldset"):"fieldset"==c?a:a.parent("label")},getProps:function(a){return 1!==a.length?console.error("getProps(): no input node provided or multiple"):{path:this.getName(a),ind:this.getIndex(a),inputType:this.getInputType(a),xmlType:this.getXmlType(a),constraint:a.attr("data-constraint"),relevant:a.attr("data-relevant"),val:this.getVal(a),required:void 0!==a.attr("required")?
!0:!1,enabled:this.isEnabled(a),multiple:this.isMultiple(a)}},getInputType:function(a){return 1!==a.length?"":"input"==a.prop("nodeName").toLowerCase()?0<a.attr("type").length?a.attr("type").toLowerCase():console.error("<input> node has no type"):"select"==a.prop("nodeName").toLowerCase()?"select":"textarea"==a.prop("nodeName").toLowerCase()?"textarea":"fieldset"==a.prop("nodeName").toLowerCase()?"fieldset":console.error("unexpected input node type provided")},getXmlType:function(a){return 1!==a.length?
console.error("getXMLType(): no input node provided or multiple"):a.attr("data-type-xml")},getName:function(a){return 1!==a.length?console.error("getName(): no input node provided or multiple"):"radio"==this.getInputType(a)?a.attr("data-name"):a.attr("name")&&0<a.attr("name").length?a.attr("name"):console.error("input node has no name")},getIndex:function(a){var c,b,e;if(1!==a.length)return console.error("getIndex(): no input node provided or multiple");c=this.getInputType(a);b=this.getName(a);e=
this.getWrapNodes(a);return("radio"===c&&b!==a.attr("name")?this.getWrapNodes(f.find('[data-name="'+b+'"]')):this.getWrapNodes(f.find('[name="'+b+'"]'))).index(e)},isMultiple:function(a){return"checkbox"==this.getInputType(a)||void 0!==a.attr("multiple")?!0:!1},isEnabled:function(a){return void 0!==a.attr("disabled")||0!==a.parents("fieldset:disabled").length?!1:!0},getVal:function(a){var c,b=[],e;if(1!==a.length)return console.error("getVal(): no inputNode provided or multiple");c=this.getInputType(a);
e=this.getName(a);return"radio"==c?this.getWrapNodes(a).find("input:checked").val()||"":"checkbox"==c?(this.getWrapNodes(a).find('input[name="'+e+'"]:checked').each(function(){b.push($(this).val())}),b):!a.val()?"":$.isArray(a.val())?a.val():a.val().trim()},setVal:function(a,c,b){c=c||0;if("radio"==this.getInputType(f.find('[data-name="'+a+'"]').eq(0)))return this.getWrapNodes(f.find('[data-name="'+a+'"]')).eq(c).find('input[value="'+b+'"]').attr("checked",!0);a=this.getWrapNodes(f.find('[name="'+
a+'"]')).eq(c).find("input, select, textarea");c=this.getInputType(a.eq(0));if("date"===c||"datetime"===c)b=g.node().convert(b,c),console.debug("converting date before setting input field to: "+b);!0===this.isMultiple(a.eq(0))&&(b=b.split(" "));a.val(b)}};d.prototype.setAllVals=function(){var a,c,b,e=this;g.node(null,null,{noEmpty:!0}).get().each(function(){b=$(this).text();c=e.generateName($(this));a=g.node(c).get().index($(this));e.input.setVal(c,a,b)})};d.prototype.setLangs=function(){var a,c,
b,e,d=this,g=f.find("#form-languages").attr("data-default-lang");$("#form-languages").detach().insertBefore($("form.jr").parent());if(!g||""===g)g=$("#form-languages a:eq(0)").attr("lang");console.debug("default language is: "+g);2>$("#form-languages a").length?(f.find("[lang]").addClass("active"),f.find(".jr-form-short.active").each(function(){0<$(this).siblings(".jr-form-long.active").length&&$(this).removeClass("active")}),this.setHints(),f.trigger("changelanguage")):($("#form-languages a").click(function(g){g.preventDefault();
a=$(this).attr("lang");$("#form-languages a").removeClass("active");$(this).addClass("active");f.find("[lang]").removeClass("active").filter('[lang="'+a+'"], [lang=""]').addClass("active");f.find(".jr-form-short.active").each(function(){0<$(this).siblings(".jr-form-long.active").length&&$(this).removeClass("active")});f.find("select > option").not('[value=""]').each(function(){b=$(this).text();c=$(this).attr("value");e=$(this).parent("select").siblings(".jr-option-translations").children('.active[data-option-value="'+
c+'"]').text().trim();e="undefined"!==typeof e&&0<e.length?e:b;$(this).text(e)});f.find("legend span.active:not(.jr-hint, .jr-constraint-msg), label span.active:not(.jr-hint, .jr-constraint-msg)").each(function(){0===$(this).text().trim().length&&$(this).text("[MISSING TRANSLATION]")});d.setHints();f.trigger("changelanguage")}),$('#form-languages a[lang="'+g+'"]').click())};d.prototype.setHints=function(){var a,c;f.find("*>.jr-hint").parent().each(function(){c="label"!==$(this).prop("nodeName").toLowerCase()&&
"fieldset"!==$(this).prop("nodeName").toLowerCase()?$(this).parent("fieldset"):$(this);a=0<c.length?$(this).find(".jr-hint.active").text().trim():$(this).find("span.jr-hint").text().trim();0<a.length?c.find(".hint").attr("title",a):c.find(".hint").removeAttr("title")});f.find("[title]").tooltip("destroy").tooltip({placement:"right"})};d.prototype.editStatus={set:function(a){f.attr("data-edited",Boolean(a));f.trigger("edit",a)},get:function(){return"true"===f.attr("data-edited")?!0:!1}};d.prototype.recordName=
{set:function(a){f.attr("data-stored-with-key",a);f.find("h2 span").text(a)},get:function(){return f.attr("data-stored-with-key")||null},reset:function(){f.removeAttr("data-stored-with-key")}};d.prototype.recordStatus={set:function(a){f.attr("data-stored-final",a.toString())},get:function(){return"true"===f.attr("data-stored-final")?!0:!1},reset:function(){f.removeAttr("data-stored-final")}};d.prototype.Branch=function(a){this.init=function(){var c;f.find("[data-relevant]").each(function(){c=a.input.getWrapNodes($(this));
1!==c.length&&console.error("branchNode wrapper could not be identified for node: ",$(this));c.addClass("jr-branch")});this.update()};this.update=function(c){var b,e,d,h,i,n={},o=this;h="undefined"!==typeof c?c.split(","):[];i=0<h.length?[]:["[data-relevant]"];for(c=0;c<h.length;c++)i.push('[data-relevant*="'+h[c]+'"]');f.find(i.join()).each(function(){b=a.input.getProps($(this));e=a.input.getWrapNodes($(this));if(!("radio"==b.inputType||"checkbox"==b.inputType)||!n[$(this).attr("name")])if(1!==e.length)console.error("could not find branch node");
else{try{d=g.evaluate(b.relevant,"boolean",b.path,b.ind)}catch(c){console.error('Serious error occurred trying to evaluate skip logic for node with name: "'+b.path+'" (message: '+c.message+")");return}n[$(this).attr("name")]=!0;console.debug(n);!0===d?o.enable(e):o.disable(e)}});return!0};this.enable=function(a){console.debug("enabling branch");a.removeClass("disabled").show(1E3);"label"==a.prop("nodeName").toLowerCase()?a.children("input, select, textarea").removeAttr("disabled"):a.removeAttr("disabled")};
this.disable=function(a){console.debug("disabling branch");a.addClass("disabled").hide(1E3);a.clearInputs("change");"label"==a.prop("nodeName").toLowerCase()?a.children("input, select, textarea").attr("disabled","disabled"):a.attr("disabled","disabled")}};d.prototype.itemsetUpdate=function(a){var c=[],b=!1;"undefined"==typeof a?c=[".itemset-template"]:$.each(a.split(","),function(a,b){c.push('.itemset-template[data-items-path*="'+b+'"]')});c=c.join(",");f.find(c).each(function(){var a,c,e,j=$(this),
d={},f=j.data(),h=$(this).prop("nodeName").toLowerCase(),l=j.closest("label, select").siblings(".itemset-labels"),i=j.attr("data-items-path"),q=l.attr("data-label-type"),w=l.attr("data-label-ref"),t=l.attr("data-value-ref"),i=g.evaluate(i,"nodes");d.length=i.length;d.text=i.text();console.debug("previous items: ",f);console.debug("new items: ",d);d.length===f.length&&d.text===f.text?console.debug("itemset unchanged"):(j.data(d),$(this).closest("label > select, fieldset > label").parent().clearInputs("change").find(h).not(j).remove(),
$(this).parent("select").siblings(".jr-option-translations").empty(),i.each(function(){a=$("<root/>");j.clone().appendTo(a).removeClass("itemset-template").addClass("itemset").removeAttr("data-items-path");c="itext"===q?l.find('[data-itext-id="'+$(this).children(w).text()+'"]').clone():$('<span class="active" lang="">'+$(this).children(w).text()+"</span>");e=$(this).children(t).text();a.find("[value]").attr("value",e);"label"===h?(a.find("input").after(c),l.before(a.find(":first"))):"option"===h&&
(b=!0,1===c.length&&a.find("option").text(c.text()),c.attr("data-option-value",e).attr("data-itext-id","").appendTo(l.siblings(".jr-option-translations")),j.siblings().andSelf().last().after(a.find(":first")))}))});b&&this.setLangs()};d.prototype.outputUpdate=function(a){var c,b,e,d,h=this,i="";setTimeout(function(){e="undefined"!==typeof a?a.split(","):[];d=0<e.length?[]:[".jr-output[data-value]"];for(c=0;c<e.length;c++)d.push('.jr-output[data-value*="'+e[c]+'"]');f.find(":not([disabled]) span.active").find(d.join()).each(function(){try{b=
$(this).attr("data-value"),i=g.evaluate(b,"string")}catch(a){console.error("error occurred trying to evaluate output value from expression: "+b+", (message:"+a.message+")"),i="[ERROR]"}$(this).text(i)});h.setHints()},1)};d.prototype.grosslyViolateStandardComplianceByIgnoringCertainCalcs=function(){var a=f.find('[name$="/meta/instanceID"][data-calculate]');0<a.length&&(console.debug("Found meta/instanceID with binding that has a calculate attribute and removed this calculation. It ain't right!"),a.removeAttr("data-calculate"))};
d.prototype.calcUpdate=function(a){var c,b,e,d,h,i,n;i="undefined"!==typeof a?a.split(","):[];n=0<i.length?[]:["input[data-calculate]"];for(a=0;a<i.length;a++)n.push('input[data-calculate*="'+i[a]+'"]');f.find("#jr-calculated-items").find(n.join()).each(function(){c=$(this).attr("name");b=$(this).attr("data-calculate");e=$(this).attr("data-type-xml");h=$(this).attr("data-constraint");d=g.evaluate(b,"string",c,null);g.node(c,null).setVal(d,h,e)})};d.prototype.bootstrapify=function(){f.find("label, legend").each(function(){var a=
$(this);0===a.siblings("legend").length&&(0===a.find(".jr-constraint-msg").length&&("legend"==a.prop("nodeName").toLowerCase()||a.children("input.ignore").length!==a.children("input").length||a.children("select.ignore").length!==a.children("select").length||a.children("textarea.ignore").length!==a.children("textarea").length))&&a.prepend('<span class="jr-constraint-msg" lang="" />')});f.find(".trigger").addClass("alert alert-block");f.find(".jr-constraint-msg").addClass("alert alert-error");f.find("label:not(.geo), fieldset").addClass("clearfix");
f.find(":checkbox, :radio").each(function(){var a=$(this).parent("label");$(this).detach().prependTo(a)})};d.prototype.widgets={init:function(){Modernizr.touch||(this.dateWidget(),this.timeWidget(),this.dateTimeWidget(),this.selectWidget());this.geopointWidget();this.pageBreakWidget();this.readonlyWidget();this.tableWidget();this.spinnerWidget();this.sliderWidget();this.barcodeWidget();this.fileWidget();this.mediaLabelWidget();this.radioWidget()},radioWidget:function(){f.on("click",'label[data-checked="true"]',
function(){$(this).removeAttr("data-checked");$(this).find("input").prop("checked",!1).trigger("change");return!1});f.on("click",'input[type="radio"]:checked',function(){$(this).parent("label").attr("data-checked","true")});f.find('input[type="radio"]:checked').parent("label").attr("data-checked","true")},dateWidget:function(){f.find('input[type="date"]').each(function(){var a=$(this),c=$(this).parent("label"),b=c.hasClass("jr-appearance-month-year")?"year":c.hasClass("jr-appearance-year")?"decade":
"month",c=c.hasClass("jr-appearance-month-year")?"changeMonth":c.hasClass("jr-appearance-year")?"changeYear":"changeDate",e="year"===b?"yyyy-mm":"decade"===b?"yyyy":"yyyy-mm-dd",d=$('<div class="widget input-append date"><input class="ignore input-small" type="text" value="'+$(this).val()+'" placeholder="'+e+'" /><span class="add-on"><i class="icon-calendar"></i></span></div>'),f=d.find("input");a.hide().after(d);f.on("change",function(){console.debug("fakedate input field change detected");var c;
c=$(this).val();c="yyyy-mm"===e?c+"-01":"yyyy"===e?c+"-01-01":c;a.val(g.node().convert(c,"date")).trigger("change");c=new Date(c.split("-")[0],Number(c.split("-")[1])-1,c.split("-")[2]);d.datepicker("setDate",new Date(c));return!1});d.datepicker({format:e,autoclose:!0,todayHighlight:!0,startView:b}).on(c,function(a){var c=$(a.currentTarget).data("datepicker");c.date=a.date;c.setValue();c.hide();f.trigger("change")})})},timeWidget:function(){f.find('input[type="time"]').each(function(){var a=$(this);
$(this).parent("label");var c=$(this).val(),b=$('<div class="widget input-append bootstrap-timepicker-component"><input class="ignore timepicker-default input-small" type="text" value="'+c+'" placeholder="hh:mm" /><span class="add-on"><i class="icon-time"></i></span></div>'),e=b.find("input");a.hide().after(b);e.timepicker({defaultTime:0<c.length?"value":"current",showMeridian:!1}).val(c);e.on("change",function(){console.debug("detected change event on fake time input");a.val($(this).val()).trigger("change");
return!1})})},dateTimeWidget:function(){f.find('input[type="datetime"]').each(function(){function a(){if(0<f.val().length&&0<g.val().length){var b=f.val().split("-"),e=g.val().split(":");console.log("changing datetime");c.val((new Date(b[0],b[1]-1,b[2],e[0],e[1])).toISOLocalString()).trigger("change")}}var c=$(this),b=(0<$(this).val().length?(new Date($(this).val())).toISOLocalString():"").split("T"),e=b[0],b=b[1]&&4<b[1].length?b[1].substring(0,5):"",e=$('<div class="input-append date" ><input class="ignore input-small" type="text" value="'+
e+'" placeholder="yyyy-mm-dd"/><span class="add-on"><i class="icon-calendar"></i></span></div>'),d=$('<div class="input-append bootstrap-timepicker-component"><input class="ignore timepicker-default input-small" type="text" value="'+b+'" placeholder="hh:mm"/><span class="add-on"><i class="icon-time"></i></span></div>'),f=e.find("input"),g=d.find("input");c.hide().after('<div class="datetimepicker" />');c.siblings(".datetimepicker").append(e).append(d);e.datepicker({format:"yyyy-mm-dd",autoclose:!0,
todayHighlight:!0});g.timepicker({defaultTime:0<b.length?"value":"current",showMeridian:!1}).val(b);f.on("change changeDate",function(){a();return!1});g.on("change",function(){a();return!1})})},selectWidget:function(){f.find("select").selectpicker();f.on("changelanguage",function(){f.find("select").selectpicker("update")})},pageBreakWidget:function(){f.find(".jr-appearance-page-break input[readonly]").parent("label").each(function(){var a='name="'+$(this).find("input").attr("name")+'"';$('<hr class="manual page-break" '+
a+"></hr>").insertBefore($(this)).find("input").remove();$(this).remove()})},readonlyWidget:function(){f.find('input[readonly]:not([data-type-xml="geopoint"])').parent("label").each(function(){var a=$(this).html(),c=$(this).find("input").attr("data-relevant"),b='name="'+$(this).find("input").attr("name")+'"';$('<fieldset class="trigger" '+("undefined"!==typeof c?'data-relevant="'+c+'" '+b:b)+"></fieldset>").insertBefore($(this)).append(a).find("input").remove();$(this).remove()})},tableWidget:function(){f.find(".jr-appearance-field-list .jr-appearance-list-nolabel, .jr-appearance-field-list .jr-appearance-label").parent().each(function(){$(this).find(".jr-appearance-label label>img").parent().toSmallestWidth();
$(this).find("label").toLargestWidth();$(this).find("legend").toLargestWidth()})},spinnerWidget:function(){},sliderWidget:function(){},geopointWidget:function(){f.find('input[data-type-xml="geopoint"]').geopointWidget({touch:Modernizr.touch})},autoCompleteWidget:function(){},barcodeWidget:function(){},fileWidget:function(){f.find('input[type="file"]').attr("placeholder","not supported yet").attr("disabled","disabled")},mediaLabelWidget:function(){$("fieldset:not(.jr-appearance-compact, .jr-appearance-quickcompact)>label, fieldset:not(.jr-appearance-compact, .jr-appearance-quickcompact)>legend").children("img,video,audio").parent().addClass("with-media")}};
d.prototype.preloads={init:function(){var a,c,b,e,d,h=this;f.find("#jr-preload-items input").each(function(){a=$(this).attr("data-preload").toLowerCase();c=$(this).attr("data-preload-params").toLowerCase();b=$(this).attr("name");"undefined"!==typeof h[a]?(e=g.node(b).getVal()[0],h.setVal($(this),h[a]({param:c,curVal:e,node:$(this)}))):console.error('Preload "'+a+'"" not supported. May or may not be a big deal.')});g.node("*>meta>*").get().each(function(){a=null;b=$(this).prop("nodeName");d=g.node("*>meta>"+
b);e=d.getVal()[0];if(0===f.find('#jr-preload-items input[name$="/meta/'+b+'"][data-preload]').length)switch(b){case "instanceID":a="instance";c="";break;case "timeStart":a="timestamp";c="start";break;case "timeEnd":a="timestamp",c="end"}a&&h.setDataVal(d,h[a]({param:c,curVal:e,dataNode:d}),null,"string")})},setVal:function(a,c){a.val(c.toString()).trigger("change")},setDataVal:function(a,c){a.setVal(c,null,"string")},timestamp:function(a){var c,b=this;return"start"==a.param?0<a.curVal.length?a.curVal:
g.evaluate("now()","string"):"end"==a.param?(f.on("beforesave",function(){c=g.evaluate("now()","string");a.node?b.setVal(a.node,c):b.setDataVal(a.dataNode,c)}),g.evaluate("now()","string")):""},date:function(a){var c,b;return 0===a.curVal.length?(c=new Date(g.evaluate("today()","string")),a=c.getUTCFullYear().toString().pad(4),b=(c.getUTCMonth()+1).toString().pad(2),c=c.getUTCDate().toString().pad(2),a+"-"+b+"-"+c):a.curVal},property:function(a){return 0===a.curVal.length?"no device properties in enketo":
a.curVal},context:function(a){return 0===a.curVal.length?"application"==a.param?"enketo":a.param+" not supported in enketo":a.curVal},patient:function(a){return 0===a.curVal.length?"patient preload not supported in enketo":a.curVal},user:function(a){return 0===a.curVal.length?"user preload item not supported in enketo yet":a.curVal},uid:function(a){return 0===a.curVal.length?"no uid yet in enketo":a.curVal},browser:function(a){return 0===a.curVal.length?"name"==a.param?$.browser.webkit?"webkit":$.browser.mozilla?
"mozilla":$.browser.opera?"opera":$.browser.msie?"msie":"unknown":"version"==a.param?$.browser.version:a.param+" not supported in enketo":a.curVal},os:function(a){return 0===a.curVal.length?"not known":a.curVal},instance:function(a){return 0<a.curVal.length?a.curVal:g.evaluate("concat('uuid:', uuid())","string")}};d.prototype.repeat={init:function(){var a,c,b,e,d,h=this;f.find("fieldset.jr-repeat").prepend('<span class="repeat-number"></span>');f.find("fieldset.jr-repeat:not([data-repeat-fixed])").append('<button type="button" class="btn repeat"><i class="icon-plus"></i></button><button type="button" disabled="disabled" class="btn remove"><i class="icon-minus"></i></button>');
f.on("click","button.repeat:enabled",function(){h.clone($(this).parent("fieldset.jr-repeat"));return!1});f.on("click","button.remove:enabled",function(){h.remove($(this).parent("fieldset.jr-repeat.clone"));return!1});f.find("fieldset.jr-repeat").each(function(){b=$(this).attr("data-repeat-count")||"";c=0<b.length?parseInt(g.node(b).getVal()[0],10):0;e=g.node($(this).attr("name")).get().length;d=c>e?c:e;for(a=1;a<d;a++)h.clone($(this).siblings().andSelf().last(),"")})},clone:function(a,c){var b,e,
d,h,i,n,o=this;if(1!==a.length)return console.error("Nothing to clone"),!1;b=a.parent("fieldset.jr-group").children("fieldset.jr-repeat:not(.clone)").eq(0);e=b.clone(!1);e.find(".clone").remove();e.addClass("clone");e.insertAfter(a).parent(".jr-group").numberRepeats();e.hide().show(600);e.clearInputs(c);e.find(".invalid input, .invalid select, .invalid textarea").each(function(){o.setValid($(this))});d=f.find('fieldset.jr-repeat[name="'+a.attr("name")+'"]').index(a);h=[];e.find('input[type="radio"]').each(function(){-1===
$.inArray($(this).attr("data-name"),h)&&h.push($(this).attr("data-name"))});console.debug("different radioNames in clone: "+h.join());for(i=0;i<h.length;i++)n=(new Date).getTime().toString()+"_"+Math.floor(1E4*Math.random()+1),e.find('input[type="radio"][data-name="'+h[i]+'"]').attr("name",n);this.toggleButtons(b.parent());b=b.attr("name");0<b.length&&0<=d&&g.cloneTemplate(b,d);f.trigger("changerepeat");return!0},remove:function(a){var c=this,b=a.attr("name"),e=f.find('fieldset.jr-repeat[name="'+
b+'"]').index(a),d=a.parent("fieldset.jr-group");a.hide(600,function(){a.remove();d.numberRepeats();c.toggleButtons(d);f.trigger("changerepeat");g.node(b,e).remove()})},toggleButtons:function(a){console.debug("toggling repeat buttons");a="undefined"==typeof a||0===a.length||!a?a=f:a;a.find("button.repeat, button.remove").attr("disabled","disabled");a.find("fieldset.jr-repeat:last-child > button.repeat").removeAttr("disabled");a.find("button.remove:not(:eq(0))").removeAttr("disabled")}};d.prototype.setEventHandlers=
function(){var a,c,b=this;$("form.jr").attr("onsubmit","return false;");f.on("change validate","input:not(.ignore), select:not(.ignore), textarea:not(.ignore)",function(e){a=b.input.getProps($(this));c="validate"==e.type?a.enabled&&"hidden"!==a.inputType?g.node(a.path,a.ind).validate(a.constraint,a.xmlType):!0:g.node(a.path,a.ind).setVal(a.val,a.constraint,a.xmlType);c=a.enabled&&"hidden"!==a.inputType&&a.required&&1>a.val.length?!1:c;if("undefined"!==typeof c&&null!==c)return!1===c?b.setInvalid($(this)):
b.setValid($(this))});f.on("dataupdate",function(a,c){b.calcUpdate(c);b.branch.update(c);b.outputUpdate(c);b.itemsetUpdate(c)});f.on("change changerepeat",function(){b.editStatus.set(!0)});f.on("changerepeat",function(){b.setAllVals()});f.on("changelanguage",function(){b.outputUpdate()})};d.prototype.setValid=function(a){this.input.getWrapNodes(a).removeClass("invalid")};d.prototype.setInvalid=function(a){this.input.getWrapNodes(a).addClass("invalid")};d.prototype.generateName=function(a){for(var c=
[a.prop("nodeName")],a=a.parent();1==a.length&&"instance"!==a.prop("nodeName")&&"#document"!==a.prop("nodeName");)c.push(a.prop("nodeName")),a=a.parent();return"/"+c.reverse().join("/")};d.prototype.validateAll=function(){var a=this;f.find("fieldset:disabled input, fieldset:disabled select, fieldset:disabled textarea, input:disabled, select:disabled, textarea:disabled").each(function(){a.setValid($(this))});f.find("input, select, textarea").not(".ignore").trigger("validate");return this.isValid()};
d.prototype.isValid=function(){return 0<f.find(".invalid").length?!1:!0};d.prototype.addPageBreaks=function(){}}GUI.prototype.setCustomEventHandlers=function(){};Date.prototype.toISOLocalString=function(){var a,b,c,e;if("Invalid Date"==this.toString())return this.toString();a=this.getTimezoneOffset();b=0>a?"+":"-";c=Math.abs(Math.floor(a/60));c=10>c?"0"+c:c;e=10>a%60?"0"+a%60:a%60;return(new Date(this.getTime()-6E4*a)).toISOString().replace("Z",b+c+":"+e)};
String.prototype.pad=function(a){for(var b=this;b.length<a;)b="0"+b;return b};
(function(a){a.fn.numberRepeats=function(){return this.each(function(){a(this).find("fieldset.jr-repeat").each(function(){var b,c,e;0===a(this).prev("fieldset.jr-repeat").length&&(b=a(this).siblings("fieldset.jr-repeat"),c=b.length+1,1<c?(a(this).find("span.repeat-number").text("1"),e=2,b.each(function(){a(this).find("span.repeat-number").text(e);e++})):a(this).find("span.repeat-number").empty())})})};a.fn.clearInputs=function(b){b=b||"edit";return this.each(function(){a(this).find("input, select, textarea").each(function(){var c=
a(this).attr("type");"SELECT"===a(this).prop("nodeName").toUpperCase()&&(c="select");"TEXTAREA"===a(this).prop("nodeName").toUpperCase()&&(c="textarea");switch(c){case "date":case "datetime":case "time":case "number":case "search":case "color":case "range":case "url":case "email":case "password":case "text":case "file":case "hidden":case "textarea":a(this).val("").trigger(b);break;case "radio":case "checkbox":a(this).prop("checked")&&(a(this).prop("checked",!1),a(this).trigger(b));break;case "select":a(this)[0].selectedIndex=
-1;a(this).trigger(b);break;default:console.error("Unrecognized input type found when trying to reset: "+c),console.error(a(this))}})})};a.fn.xfind=function(a){var c,e,a=a.replace(/\/\//g," "),a=a.replace(/^\//,""),a=a.replace(/\/\.$/,""),a=a.replace(/\//g,">"),a=a.replace(/\[([^@].*?)\]/g,function(a,c){return":has("+c+")"});if(0<=a.indexOf(">..")){a=a.split(/>\.\.>?/g);c=jQuery(a[0],this);for(e=1;e<a.length;e++)c=c.parent(a[e]);return c.get()}a=a.replace(/\./gi,"\\.");return this.find(a)}})(jQuery);/*
 Copyright 2012 Martijn van de Rijdt & Modilabs

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
*/
!function(a){var b=function(c,b,d){d&&(d.stopPropagation(),d.preventDefault());this.$element=a(c);this.$newElement=null;this.selectClass=b.btnStyle||"";this.noneSelectedText=b.noneSelectedText||"None selected";this.lengthmax=b.maxlength||20;this.multiple="undefined"!==typeof this.$element.attr("multiple")&&!1!==this.$element.attr("multiple");this.init()};b.prototype={contructor:b,init:function(){this.$element.css("display","none");var a=this.getTemplate(),a=this.createLi(a);this.$element.after(a);
this.$newElement=this.$element.next(".bootstrap-select");this.$newElement.find("> a").addClass(this.selectClass);this.clickListener()},getTemplate:function(){return"<div class='btn-group bootstrap-select'><a class='btn dropdown-toggle clearfix' data-toggle='dropdown' href='#''><span class='filter-option pull-left'>__SELECTED_OPTIONS</span><span class='caret pull-right'></span></a><ul class='dropdown-menu' role='menu'>__ADD_LI</ul></div>"},createLi:function(c){var b=[],d="",g=this.multiple?"type='checkbox'":
"type='radio' style='display: none;' name='"+1E5*Math.random()+"'",h;this.$element.find("option").each(function(){b.push([a(this).text(),a(this).is(":selected")])});if(0<b.length)for(var c=c.replace("__SELECTED_OPTIONS",this.createSelectedStr()),i=0;i<b.length;i++)h=b[i][1]?" checked='checked'":"",d+="<li rel="+i+"><a tabindex='-1' href='#'><label class='checkbox inline'><input class='ignore' "+g+h+" />"+b[i][0]+"</label></a></li>";return c=c.replace("__ADD_LI",d)},createSelectedStr:function(c){var b=
[],c=c||this.$element;c.find("option:selected").each(function(){b.push(a(this).text())});if(0===b.length)return this.noneSelectedText;c=b.join(", ");return c.length>this.lengthmax?b.length+" selected":c},clickListener:function(){var c=this;this.$newElement.find("li").on("click",function(b){b.preventDefault();var d=a(this).attr("rel"),b=a(this).find("input"),g=a(this).parents(".bootstrap-select"),h=g.prev("select"),d=h.find("option").eq(parseInt(d,10)),i=d.is(":selected");c.multiple||(d.siblings("option").removeAttr("selected"),
g.find("input").removeAttr("checked"));i?(b.prop("checked",!1).removeAttr("checked"),d.removeAttr("selected")):(b.prop("checked",!0),d.attr("selected","selected"));g.find(".filter-option").html(c.createSelectedStr(h));h.trigger("change")})},update:function(){this.$newElement.remove();this.init()}};a.fn.selectpicker=function(c,e){return this.each(function(){var d=a(this),g=d.data("selectpicker"),h="object"==typeof c&&c;g||d.data("selectpicker",g=new b(this,h,e));if("string"==typeof c)g[c]()})};a.fn.selectpicker.Constructor=
b}(window.jQuery);
!function(a){var b=function(c,b){this.$inputOrigin=a(c);this.$form=this.$inputOrigin.closest("form");this.$widget=a('<div class="geopoint widget"><div class="search-bar no-search-input"></div><div class="geo-inputs"><label class="geo">latitude (x.y &deg;)<input class="ignore" name="lat" type="number" step="0.0001" /></label><label class="geo">longitude (x.y &deg;)<input class="ignore" name="long" type="number" step="0.0001" /></label><label class="geo"><input class="ignore" name="alt" type="number" step="0.1" />altitude (m)</label><label class="geo"><input class="ignore" name="acc" type="number" step="0.1" />accuracy (m)</label></div></div>');navigator.geolocation&&
(this.$widget.find(".search-bar").append('<button name="geodetect" type="button" class="btn" title="detect current location" data-placement="top"><i class="icon-crosshairs"></i></button>'),this.$detect=this.$widget.find('button[name="geodetect"]'));!0!==b.touch&&(this.$widget.find(".search-bar").removeClass("no-search-input").append('<div class="input-append"><input class="geo ignore" name="search" type="text" placeholder="search for place or address" disabled="disabled"/><button type="button" class="btn add-on"><i class="icon-search"></i></div>'),
this.$search=this.$widget.find('[name="search"]'));if(!0!==b.touch||!0===b.touch&&0<this.$inputOrigin.parents(".jr-appearance-maps").length)this.$widget.find(".search-bar").after('<div class="map-canvas-wrapper"><div class="map-canvas"></div></div>'),this.$map=this.$widget.find(".map-canvas");this.$lat=this.$widget.find('[name="lat"]');this.$lng=this.$widget.find('[name="long"]');console.debug("this.$lng: ",this.$lng);this.$alt=this.$widget.find('[name="alt"]');this.$acc=this.$widget.find('[name="acc"]');
this.$inputOrigin.hide().after(this.$widget);this.updateMapFn="updateDynamicMap";this.touch=b.touch||!1;this.init()};b.prototype={constructor:b,init:function(){var c=this,b=this.$inputOrigin.val().split(" ");this.$widget.find('input:not([name="search"])').on("change change.bymap change.bysearch",function(a){var b=""!==c.$lat.val()?c.$lat.val():0,e=""!==c.$lng.val()?c.$lng.val():0,i=""!==c.$alt.val()?c.$alt.val():0,f=c.$acc.val();c.$inputOrigin.val(b+" "+e+" "+i+" "+f).trigger("change");"bymap"!==
a.namespace&&"bysearch"!==a.namespace&&c.updateMap(b,e);"bysearch"!==a.namespace&&this.$search&&c.$search.val("");return!1});b[3]&&this.$acc.val(b[3]);b[2]&&this.$alt.val(b[2]);b[1]&&this.$lng.val(b[1]);0<b[0].length&&this.$lat.val(b[0]).trigger("change");this.$detect&&this.enableDetection();if(this.touch)this.$map&&(this.updateMapFn="updateStaticMap",this.updateMap(0,0,1),a(window).on("resize",this.updateMap));else this.$form.on("googlemapsscriptloaded",function(){c.dynamicMapAvailable()&&(c.updateMap(0,
0,1),c.$search&&c.enableSearch())});console.log("this in init:",this)},enableDetection:function(){var a=this;this.$detect.click(function(b){b.preventDefault();navigator.geolocation.getCurrentPosition(function(b){a.updateMap(b.coords.latitude,b.coords.longitude);a.updateInputs(b.coords.latitude,b.coords.longitude,b.coords.altitude,b.coords.accuracy)});return!1})},enableSearch:function(){var c=new google.maps.Geocoder,b=this;this.$search.removeAttr("disabled");this.$search.on("change",function(d){d.stopImmediatePropagation();
var g=a(this).val();"undefined"!==typeof c&&c.geocode({address:g,bounds:b.map.getBounds()},function(a,c){if(c==google.maps.GeocoderStatus.OK){b.$search.attr("placeholder","search");var d=a[0].geometry.location;b.updateMap(d.lat(),d.lng());b.updateInputs(d.lat(),d.lng(),null,null,"change.bysearch")}else b.$search.val(""),b.$search.attr("placeholder",g+" not found, try something else.")});return!1})},dynamicMapAvailable:function(){return this.$map&&"undefined"!==typeof google&&"undefined"!==typeof google.maps},
updateMap:function(a,b,d){console.debug("this: ",this);a=a||Number(this.$lat.val());b=b||Number(this.$lng.val());return this[this.updateMapFn](a,b,d||15)},updateStaticMap:function(a,b,d){var g=this.$map.width(),h=this.$map.height(),a="center="+a+","+b+"&size="+g+"x"+h+"&zoom="+d+"&sensor=false";this.$map.empty().append('<img src="http://maps.googleapis.com/maps/api/staticmap?'+a+'"/>')},updateDynamicMap:function(a,b,d){var g=this;this.dynamicMapAvailable&&"undefined"!==typeof google.maps.LatLng&&
(a={zoom:d,center:new google.maps.LatLng(a,b),mapTypeId:google.maps.MapTypeId.ROADMAP,streetViewControl:!1},this.map=new google.maps.Map(this.$map[0],a),this.placeMarker(),google.maps.event.addListener(this.map,"click",function(a){g.updateInputs(a.latLng.lat(),a.latLng.lng(),"","","change.bymap");g.placeMarker(a.latLng)}))},placeMarker:function(a){var b,a=a||this.map.getCenter();"undefined"!==typeof this.marker&&this.marker.setMap(null);this.marker=new google.maps.Marker({position:a,map:this.map,
draggable:!0});b=this;this.touch||(google.maps.event.addListener(this.marker,"dragend",function(){b.updateInputs(b.marker.getPosition().lat(),b.marker.getPosition().lng(),"","","change.bymap");b.centralizeWithDelay()}),this.centralizeWithDelay(5E3));this.centralizeWithDelay(0)},centralizeWithDelay:function(a){var b=this;window.setTimeout(function(){b.map.panTo(b.marker.getPosition())},a)},updateInputs:function(a,b,d,g,h){d=d||"";g=g||"";h=h||"change";this.$lat.val(Math.round(1E4*a)/1E4);this.$lng.val(Math.round(1E4*
b)/1E4);this.$alt.val(Math.round(10*d)/10);this.$acc.val(Math.round(10*g)/10).trigger(h)},loadMapsScript:function(){}};a.fn.geopointWidget=function(c){if("undefined"!==typeof connection&&("undefined"==typeof google||"undefined"==typeof google.maps)&&!c.touch)console.debug("loading maps script asynchronously"),connection.loadGoogleMaps(function(){a("form.jr").trigger("googlemapsscriptloaded")});return this.each(function(){var e=a(this),d=a(this).data("geopointwidget"),g="object"==typeof c&&c;d||e.data("geopointwidget",
d=new b(this,g));if("string"==typeof c)d[c]()})};a.fn.geopointWidget.Constructor=b}(window.jQuery);/*
 Copyright 2012 Martijn van de Rijdt

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
*/
function Connection(){var a=this;this.CONNECTION_URL="/checkforconnection.php";this.SUBMISSION_URL="/data/submission";this.GETSURVEYURL_URL="/launch/get_survey_url";this.SUBMISSION_TRIES=2;this.uploadOngoing=this.currentOnlineStatus=!1;this.init=function(){this.checkOnlineStatus();a=this;window.setInterval(function(){a.checkOnlineStatus()},15E3);$(window).on("offline online",function(){console.log("window network event detected");a.setOnlineStatus(a.getOnlineStatus())});$(window).trigger("online")}}
Connection.prototype.checkOnlineStatus=function(){var a,b=this;navigator.onLine?$.ajax({type:"GET",url:this.CONNECTION_URL,cache:!1,dataType:"json",timeout:3E3,complete:function(c){a="undefined"!==typeof c.responseText&&"connected"===c.responseText;b.setOnlineStatus(a)}}):this.setOnlineStatus(!1)};Connection.prototype.getOnlineStatus=function(){return this.currentOnlineStatus};
Connection.prototype.setOnlineStatus=function(a){a!==this.currentOnlineStatus&&(console.log("online status changed to: "+a+", triggering window.onlinestatuschange"),$(window).trigger("onlinestatuschange",a));this.currentOnlineStatus=a};
Connection.prototype.uploadRecords=function(a,b,c){b="undefined"!==typeof b?b:!1;a="object"===typeof a&&!$.isArray(a)?[a]:a;c="undefined"===typeof c?null:c;if(0===a.length)return!1;this.uploadOngoing||(this.uploadResult={win:[],fail:[]},this.uploadQueue=a,this.forced=b,console.debug("upload queue length: "+this.uploadQueue.length),this.uploadOne(c));return!0};
Connection.prototype.uploadOne=function(a){var b,c,e,d=this,a="undefined"===typeof a||!a?{complete:function(a){d.processOpenRosaResponse(a.status,b.name,e);d.uploadOne()},error:function(a,b){"timeout"===b?console.debug("submission request timed out"):console.error("error during submission",b)},success:function(){}}:a;0<this.uploadQueue.length&&(b=this.uploadQueue.pop(),!0!==this.getOnlineStatus()?this.processOpenRosaResponse(0,b.name,!0):(this.uploadOngoing=!0,c=new FormData,c.append("xml_submission_data",
b.data),c.append("Date",(new Date).toUTCString()),e=0===this.uploadQueue.length?!0:!1,this.setOnlineStatus(null),$.ajax(this.SUBMISSION_URL,{type:"POST",data:c,cache:!1,contentType:!1,processData:!1,timeout:6E4,complete:function(b,c){d.uploadOngoing=!1;a.complete(b,c)},error:a.error,success:a.success})))};
Connection.prototype.processOpenRosaResponse=function(a,b,c){var e,d="";e=[];var g="Contact "+settings.supportEmail+" please.",h="Sorry, the enketo server is down or being maintained. Please try again later or contact "+settings.supportEmail+" please.",g={"0":{success:!1,msg:"undefined"!==typeof jrDataStrToEdit?"Uploading of data failed. Please try again.":"Uploading of data failed (maybe offline) and will be tried again later."},200:{success:!1,msg:"Data server did not accept data. "+g},201:{success:!0,
msg:""},202:{success:!0,msg:b+" may have had errors. Contact the survey administrator please."},"2xx":{success:!1,msg:"Unknown error occurred when submitting data. "+g},400:{success:!1,msg:"Data server did not accept data. Contact the survey administrator please."},403:{success:!1,msg:"You are not allowed to post data to this data server. Contact the survey administrator please."},404:{success:!1,msg:"Submission service on data server not found or not properly configured."},"4xx":{success:!1,msg:"Unknown submission problem on data server."},
413:{success:!1,msg:"Data is too large. Please export the data and contact "+settings.supportEmail+"."},500:{success:!1,msg:h},503:{success:!1,msg:h},"5xx":{success:!1,msg:h}};console.debug("name: "+b+" status: "+a);"undefined"!==typeof g[a]?!0===g[a].success?("undefined"!==typeof store&&(store.removeRecord(b),console.log("tried to remove record with key: "+b)),$("form.jr").trigger("uploadsuccess",b),this.uploadResult.win.push([b,g[a].msg])):!1===g[a].success&&this.uploadResult.fail.push([b,g[a].msg]):
500<a?(console.error("Error during uploading, received unexpected statuscode: "+a),this.uploadResult.fail.push([b,g["5xx"].msg])):400<a?(console.error("Error during uploading, received unexpected statuscode: "+a),this.uploadResult.fail.push([b,g["4xx"].msg])):200<a&&(console.error("Error during uploading, received unexpected statuscode: "+a),this.uploadResult.fail.push([b,g["2xx"].msg]));if(!0===c){console.debug("going to provide upload feedback (forced = "+this.forced+") from object:");console.debug(this.uploadResult);
if(0<this.uploadResult.win.length){for(a=0;a<this.uploadResult.win.length;a++)e.push(this.uploadResult.win[a][0]),d="undefined"!==typeof this.uploadResult.win[a][2]?d+this.uploadResult.win[a][1]+" ":"";a=1<a?" were":" was";e=e.join(", ");gui.showFeedback(e.substring(0,e.length)+a+" successfully uploaded. "+d);this.setOnlineStatus(!0)}if(0<this.uploadResult.fail.length&&(this.setOnlineStatus(!1),!0===this.forced)){for(a=0;a<this.uploadResult.fail.length;a++)d+=this.uploadResult.fail[a][0]+": "+this.uploadResult.fail[a][1]+
"<br />";$(".drawer.left.closed .handle").click();gui.alert(d,"Failed data submission")}}};Connection.prototype.isValidURL=function(a){return/^(https?:\/\/)([\da-z\.\-]+)\.([a-z\.]{2,6})([\/\w \.\-]*)*\/?[\/\w \.\-\=\&\?]*$/.test(a)};
Connection.prototype.getFormlist=function(a,b){b=this.getCallbacks(b);this.isValidURL(a)?$.ajax("/forms/get_list",{type:"GET",data:{server_url:a},cache:!1,contentType:"json",timeout:6E4,success:b.success,error:b.error,complete:b.complete}):b.error(null,"validationerror","not a valid URL")};
Connection.prototype.getSurveyURL=function(a,b,c){c=this.getCallbacks(c);!a||!this.isValidURL(a)?c.error(null,"validationerror","not a valid server URL"):!b||0===b.length?c.error(null,"validationerror","not a valid formId"):$.ajax({url:this.GETSURVEYURL_URL,type:"POST",data:{server_url:a,form_id:b},cache:!1,timeout:6E4,dataType:"json",success:c.success,error:c.error,complete:c.complete})};
Connection.prototype.getFormHTML=function(a,b){var c,e,d,g=new FormData(a[0]),b=this.getCallbacks(b);c=a.find('input[name="server_url"]').val()||"";e=a.find('input[name="form_id"]').val()||"";d=a.find('input[name="xml_file"]').val()||"";""===d&&""===c&&""===e?b.error(null,"validationerror","No form file or URLs provided"):""===d&&!this.isValidURL(c)?b.error(null,"validationerror","Not a valid server url"):""===d&&0===e.length?b.error(null,"validationerror","No form id provided"):$.ajax("/transform/get_html_form",
{type:"POST",cache:!1,contentType:!1,processData:!1,dataType:"xml",data:g,success:b.success,error:b.error,complete:b.complete})};Connection.prototype.validateHTML=function(a,b){var c=new FormData,b=this.getCallbacks(b);c.append("level","error");c.append("content",a);$.ajax("/html5validate/",{type:"POST",data:c,contentType:!1,processData:!1,success:b.success,error:b.error,complete:b.complete})};
Connection.prototype.oRosaHelper={fragToServerURL:function(a,b){var c;c="";if(!b)return console.log("nothing to do"),null;switch(a){case "http":case "https":c=/^http(|s):\/\//.test(b)?"":a+"://";c+=b;break;case "formhub_uni":case "formhub":c="http://formhub.org/"+b;break;case "appspot":c="https://"+b+".appspot.com"}if(!connection.isValidURL(c))return console.error("not a valid url: "+c),null;console.log("server_url: "+c);return c}};
Connection.prototype.loadGoogleMaps=function(a){var b=settings.mapsAPIKey||"",c=document.createElement("script");window.googleMapsInit=a;c.type="text/javascript";c.src="http://maps.googleapis.com/maps/api/js?v=3.exp&key="+b+"&sensor=false&libraries=places&callback=googleMapsInit";document.body.appendChild(c)};
Connection.prototype.getCallbacks=function(a){a=a||{};a.error=a.error||function(a,c,e){console.error(c+" : "+e)};a.complete=a.complete||function(){};a.success=a.success||function(){console.log("success!")};return a};/*
 Copyright 2012 Martijn van de Rijdt

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
*/
function loadForm(a,b){var c;!b&&form.getEditStatus()?(c={posAction:function(){loadForm(a,!0)}},gui.confirm("Would you like to proceed without saving changes to the form you were working on?",c)):(c=store.getRecord(a),null!==c.data?(form.resetHTML(),form=new Form("form.jr:eq(0)",c.data),form.init(),form.setRecordName(a),$("#page-close").click(),$("button#delete-form").button("enable"),gui.showFeedback('"'+a+'" has been loaded',2)):gui.alert("Record contained no data"))}
function saveForm(a,b,c,e){var d;d=form.getRecordName();var g=form.getRecordStatus(),h={};console.debug("new name: "+a+", before: "+d+", delOld: "+c+", overwr: "+e);if(null===form.getDataStr(!0,!0)||""===form.getDataStr(!0,!0))return gui.showFeedback("Nothing to save.");if("undefined"==typeof a||0===a.length)return d=d||store.getCounterValue(),$('#dialog-save input[name="record-name"]').val(d),$('#dialog-save input[name="record-final"]').attr("checked",g),gui.saveConfirm();if(d&&d!==a&&"undefined"==
typeof c)return e={posButton:"Yes, delete",negButton:"No, keep",posAction:function(){saveForm(a,b,!0)},negAction:function(){saveForm(a,b,!1)}},gui.confirm({msg:"Record name has changed. Would you like to delete the record saved under the old name:"+d+"?",heading:"Delete old Record?"},e);$("form.jr").trigger("beforesave");h={data:form.getDataStr(!0,!0),ready:b};d=store.setRecord(a,h,c,e,d);console.log("result of save: "+d);"success"===d?(gui.showFeedback('Form with name "'+a+'" has been saved.',2),
form.setRecordName(a),form.setRecordStatus(b),form.setEditStatus(!1),$("button#delete-form").button("enable"),$("form.jr").trigger("save",JSON.stringify(store.getRecordList()))):"existing"===d?(e={posButton:"Yes, overwrite",posAction:function(){saveForm(a,b,c,!0)},negAction:function(){gui.showFeedback("Form was not saved.")}},gui.confirm("Record with name "+a+" already exists. Would you like to overwrite existing record? ",e)):"forbidden"===d?(gui.alert("This name is not allowed. Please change it"),
gui.showFeedback("Form was NOT saved.")):gui.showFeedback("Error occurred. Form was NOT saved.")}function resetForm(a){console.debug("editstatus: "+form.getEditStatus());!a&&form.getEditStatus()?(a={posAction:function(){resetForm(!0)}},gui.confirm("There are unsaved changes, would you like to continue <strong>without</strong> saving those?",a)):(form.resetHTML(),form=new Form("form.jr:eq(0)",jrDataStr),form.init(),$("button#delete-form").button("disable"))}
function deleteForm(a){var b=form.getRecordName();""!==b&&null!==b?a?store.removeRecord(b)?(resetForm(!0),gui.showFeedback("Successfully deleted form."),$("form.jr").trigger("delete",JSON.stringify(store.getRecordList()))):gui.showFeedback("An error occurred when trying to delete this form."):(a={posButton:"Delete",posAction:function(){deleteForm(!0)}},gui.confirm("Please confirm that you would like to remove this form from storage.",a)):gui.showFeedback("Please first load the form you would like to delete or choose reset if you'd like to reset the current form.")}
function submitForm(){var a;$("form.jr").trigger("beforesave");form.isValid()?(a={data:form.getDataStr(!0,!0),ready:!0},a=store.setRecord(form.getName()+" - "+store.getCounterValue(),a,!1,!1),console.log("result of save: "+a),"success"===a?(resetForm(!0),$("form.jr").trigger("save",JSON.stringify(store.getRecordList())),connection.uploadRecords(store.getSurveyDataArr(!0),!0)):gui.alert("Error trying to save data locally before submit")):gui.alert("Form contains errors <br/>(please see fields marked in red)")}
function submitEditedForm(){var a,b,c;$("form.jr").trigger("beforesave");form.isValid()?(b="undefined"!==typeof RETURN_URL?!0:!1,gui.alert((b?"You will be automatically redirected after submission. ":"")+'<br /><progress style="text-align: center;"/>',"Submitting..."),a={data:form.getDataStr(!0,!0)},c={error:function(){gui.alert("Please try submitting again.","Submission failed")},success:function(){b?(gui.alert("You will now be redirected back to formhub.","Submission successful!"),location.href=
RETURN_URL):(gui.alert("Done!","Submission successful!"),resetForm(!0))}},connection.uploadRecords(a,!0,c)):gui.alert("Form contains errors <br/>(please see fields marked in red)")}function exportData(a){a=store.getSurveyDataOnlyArr(a||!0);0===a.length?gui.showFeedback("No data to export."):(a=vkbeautify.xml("<exported>"+a.join("")+"</exported>"),a="data:application/octet-stream,"+encodeURIComponent(a),window.open(a,"exportedData"))}
function exportToFile(a,b){var c,e,b=b||!0,a=a||form.getName()+"_data_backup.xml";c=store.getSurveyDataOnlyArr(b);!c||0===c.length?gui.showFeedback('No data marked "final" to export.'):(c=vkbeautify.xml("<exported>"+c.join("")+"</exported>"),e=new BlobBuilder,e.append(c),c=e.getBlob("application/octet-stream; charset=utf-8"),saveAs(c,a))}
GUI.prototype.setCustomEventHandlers=function(){var a=this;$("button#save-form").click(function(){form.validateForm();saveForm()});$("button#reset-form").click(function(){resetForm()});$("button#delete-form").click(function(){deleteForm(!1)});$("button#submit-form").button().click(function(){form.validateForm();submitForm();return!1});$("button#submit-edited-data").click(function(){form.validateForm();submitEditedForm();return!1});$("#drawer-export").click(function(){exportToFile();return!1});$(".drawer.left .handle.right").click(function(){var a=
$(this).parent(".drawer");console.debug("clicked handle");a.toggleClass("closed")});$("#form-controls button").toLargestWidth();$(document).on("click","#records-saved li:not(.no-click)",function(a){a.preventDefault();a=$(this).find(".name").text();loadForm(a);$(this).siblings().removeClass("ui-state-active");$(this).addClass("ui-state-active")}).on("mouseenter","#records-saved li:not(.no-click)",function(){$(this).addClass("ui-state-hover")}).on("mouseleave","#records-saved li:not(.no-click)",function(){$(this).removeClass("ui-state-hover")});
$(document).on("save delete","form.jr",function(b,c){console.debug("save or delete event detected with new formlist: "+c);a.updateRecordList(JSON.parse(c))});$(document).on("setsettings",function(b,c){a.setSettings(c)});this.pages.get("settings").on("change","input",function(){var a=$(this).attr("name"),c=$(this).is(":checked")?$(this).val().toString():"";console.debug("settings change by user detected");settings.set(a,c)});$("#dialog-save").hide()};
GUI.prototype.updateRecordList=function(a,b){var c,e,d,g,h,i=0,f=0;console.debug("updating recordlist in GUI");b||(b=this.pages.get("records"));h=b.find("#records-saved ol");h.children().remove();a=a||[];if(0<a.length){for(d=0;d<a.length;d++)c=a[d].key,e=(new Date(a[d].lastSaved)).toDateString(),a[d].ready?(g="check",i++):(g="pencil",f++),e=$('<li><span class="ui-icon ui-icon-'+g+'"></span><span class="name"></span><span class="date"> ('+e+")</span></li>"),e.find(".name").text(c),h.append(e);$("#queue-length").text(a.length)}else $('<li class="no-click">no locally saved records found</li>').appendTo(h),
$("#queue-length").text("0");b.find("#records-draft-qty").text(f);b.find("#records-final-qty").text(i)};
GUI.prototype.saveConfirm=function(){var a=$("#dialog-save");this.confirm({dialog:"save",msg:"",heading:"Record Details"},{posButton:"Ok",negButton:"Cancel",posAction:function(){console.debug("value of final in confirm dialog: "+Boolean(a.find('[name="record-final"]:checked').val()));return saveForm(a.find('[name="record-name"]').val(),Boolean(a.find('[name="record-final"]:checked').val()))},negAction:function(){return!1},beforeAction:function(){form.isValid()?(console.log("form valid"),a.find('[name="record-final"]').removeAttr("disabled")):
(console.log("form invalid"),a.find('[name="record-final"]').attr("disabled","disabled"))}})};/*
 Copyright 2012 Martijn van de Rijdt

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
*/
var form,connection,currentOnlineStatus=!1,store;$(document).ready(function(){form=new Form("form.jr:eq(0)",jrDataStr,jrDataStrToEdit);connection=new Connection;form.init();connection.init();gui.setup()});